name: Deployment Validation

on:
  workflow_run:
    workflows: ["IaL Deploy with Bedrock Intelligent Testing"]
    types:
      - completed
  schedule:
    # Run validation every hour
    - cron: '0 * * * *'
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'phases/**/*.yaml'

env:
  PROJECT_NAME: ial
  AWS_REGION: us-east-1
  MIN_SECURITY_SCORE: 80
  MIN_RELIABILITY_SCORE: 80
  S3_REPORTS_BUCKET: ial-reports-bucket

jobs:
  policy-lint:
    name: üîí Policy Linter
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install boto3 pyyaml
      
      - name: Run Policy Linter
        id: policy_lint
        run: |
          python3 tools/policy-validation/lint_policies.py
          echo "policy_exit_code=$?" >> $GITHUB_OUTPUT
      
      - name: Upload Policy Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: policy-lint-report
          path: reports/policy_lint_report.json
      
      - name: Fail on High Severity Violations
        if: steps.policy_lint.outputs.policy_exit_code != '0'
        run: |
          echo "‚ùå Policy linting failed with high severity violations"
          echo "Review the policy lint report for details"
          exit 1

  well-architected-gate:
    name: üèóÔ∏è Well-Architected Gate
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: policy-lint
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install boto3 pyyaml
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Run Well-Architected Assessment
        id: wa_assessment
        env:
          MIN_SECURITY_SCORE: ${{ env.MIN_SECURITY_SCORE }}
          MIN_RELIABILITY_SCORE: ${{ env.MIN_RELIABILITY_SCORE }}
          S3_REPORTS_BUCKET: ${{ env.S3_REPORTS_BUCKET }}
        run: |
          python3 scripts/mcp_well_architected_security.py
          echo "wa_exit_code=$?" >> $GITHUB_OUTPUT
      
      - name: Upload WA Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: well-architected-report
          path: reports/well-architected-*.json
      
      - name: Fail on Low Security/Reliability Scores
        if: steps.wa_assessment.outputs.wa_exit_code != '0'
        run: |
          echo "‚ùå Well-Architected assessment failed"
          echo "Security or Reliability scores below threshold"
          exit 1

  validate-deployment:
    name: üìã Deployment Validation
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [policy-lint, well-architected-gate]
    
    permissions:
      id-token: write
      contents: read
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install boto3 pyyaml
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Run Deployment Validation
        id: validation
        run: |
          export PROJECT_NAME=${{ env.PROJECT_NAME }}
          python3 scripts/validate-deployment.py
          echo "validation_exit_code=$?" >> $GITHUB_OUTPUT
      
      - name: Run Health Check
        run: |
          python3 scripts/deployment-health-check.py
      
      - name: Upload Validation Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-reports
          path: |
            reports/deployment_validation.json
            reports/deployment_health.json
      
      - name: Create Issue on Validation Failure
        if: steps.validation.outputs.validation_exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            try {
              const validation = JSON.parse(fs.readFileSync('reports/deployment_validation.json', 'utf8'));
              
              const issueBody = `## üö® Deployment Validation Failed
              
              **Status:** ${validation.status}
              **Completion Rate:** ${validation.completion_rate.toFixed(1)}%
              **Expected Resources:** ${validation.expected_total}
              **Created Resources:** ${validation.created_total}
              
              ### Missing Resources
              ${validation.missing_resources.map(missing => 
                `- **${missing.phase}:** ${missing.missing_count} missing (${missing.created}/${missing.expected})`
              ).join('\n')}
              
              ### Issues
              ${validation.issues.map(issue => `- ${issue}`).join('\n')}
              
              ### Phase Analysis
              ${Object.entries(validation.phase_analysis).map(([phase, analysis]) => 
                `- **${phase}:** ${analysis.created}/${analysis.expected} (${analysis.completion_rate.toFixed(0)}%) ${analysis.status === 'COMPLETE' ? '‚úÖ' : '‚ùå'}`
              ).join('\n')}
              
              ---
              **Validation Time:** ${validation.timestamp}
              **Workflow:** ${context.workflow} #${context.runNumber}
              
              Please review and resolve missing resources before proceeding.`;
              
              // Check if issue already exists
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'deployment-validation'
              });
              
              if (existingIssues.data.length === 0) {
                // Create new issue
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `üö® Deployment Validation Failed - ${validation.completion_rate.toFixed(1)}% Complete`,
                  body: issueBody,
                  labels: ['deployment-validation', 'bug', 'high-priority']
                });
              } else {
                // Update existing issue
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssues.data[0].number,
                  title: `üö® Deployment Validation Failed - ${validation.completion_rate.toFixed(1)}% Complete`,
                  body: issueBody
                });
              }
            } catch (error) {
              console.log('Could not create/update validation issue:', error.message);
            }
      
      - name: Close Validation Issue on Success
        if: steps.validation.outputs.validation_exit_code == '0'
        uses: actions/github-script@v7
        with:
          script: |
            // Close existing validation issues
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'deployment-validation'
            });
            
            for (const issue of existingIssues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '‚úÖ Deployment validation now passes. All resources have been successfully created.'
              });
            }
      
      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.validation.outputs.validation_exit_code }}" = "0" ]; then
            echo "‚úÖ Deployment validation PASSED - All resources created successfully"
          else
            echo "‚ùå Deployment validation FAILED - Some resources are missing"
            echo "Check the validation report for details"
          fi
