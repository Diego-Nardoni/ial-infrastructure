{
  "phase_number": 40,
  "phase_name": "database-alb",
  "yaml_content": "```yaml\n---\nAWSTemplateFormatVersion: '2010-09-09'\nDescription: Web application with load balancer and database\n\nParameters:\n  EnvironmentName:\n    Description: An environment name that will be prefixed to resource names\n    Type: String\n    Default: dev\n\n  VpcCIDR:\n    Description: Please enter the IP range (CIDR notation) for this VPC\n    Type: String\n    Default: 10.0.0.0/16\n\n  PublicSubnet1CIDR:\n    Description: Please enter the IP range (CIDR notation) for the public subnet in the first Availability Zone\n    Type: String\n    Default: 10.0.0.0/24\n\n  PublicSubnet2CIDR:\n    Description: Please enter the IP range (CIDR notation) for the public subnet in the second Availability Zone\n    Type: String\n    Default: 10.0.1.0/24\n\n  PrivateSubnet1CIDR:\n    Description: Please enter the IP range (CIDR notation) for the private subnet in the first Availability Zone\n    Type: String\n    Default: 10.0.2.0/24\n\n  PrivateSubnet2CIDR:\n    Description: Please enter the IP range (CIDR notation) for the private subnet in the second Availability Zone\n    Type: String\n    Default: 10.0.3.0/24\n\n  EC2InstanceType:\n    Description: EC2 instance type for the web application\n    Type: String\n    Default: t3.micro\n    AllowedValues:\n      - t2.micro\n      - t3.micro\n      - t3.small\n\n  DBInstanceType:\n    Description: RDS instance type for the database\n    Type: String\n    Default: db.t3.micro\n    AllowedValues:\n      - db.t3.micro\n      - db.t3.small\n      - db.t4g.medium\n\nResources:\n\n  # VPC\n  VPC:\n    Type: AWS::EC2::VPC\n    Properties:\n      CidrBlock: !Ref VpcCIDR\n      EnableDnsHostnames: true\n      EnableDnsSupport: true\n      InstanceTenancy: default\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-vpc'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T15:01:04.801610\n\n  # Internet Gateway\n  InternetGateway:\n    Type: AWS::EC2::InternetGateway\n    Properties:\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-igw'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T15:01:04.801610\n\n  # Attach Internet Gateway to VPC\n  InternetGatewayAttachment:\n    Type: AWS::EC2::VPCGatewayAttachment\n    Properties:\n      VpcId: !Ref VPC\n      InternetGatewayId: !Ref InternetGateway\n\n  # Public Subnet 1\n  PublicSubnet1:\n    Type: AWS::EC2::Subnet\n    Properties:\n      VpcId: !Ref VPC\n      AvailabilityZone: !Select [0, !GetAZs '']\n      CidrBlock: !Ref PublicSubnet1CIDR\n      MapPublicIpOnLaunch: true\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-public-subnet-1'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T15:01:04.801610\n\n  # Public Subnet 2\n  PublicSubnet2:\n    Type: AWS::EC2::Subnet\n    Properties:\n      VpcId: !Ref VPC\n      AvailabilityZone: !Select [1, !GetAZs '']\n      CidrBlock: !Ref PublicSubnet2CIDR\n      MapPublicIpOnLaunch: true\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-public-subnet-2'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T15:01:04.801610\n\n  # Private Subnet 1\n  PrivateSubnet1:\n    Type: AWS::EC2::Subnet\n    Properties:\n      VpcId: !Ref VPC\n      AvailabilityZone: !Select [0, !GetAZs '']\n      CidrBlock: !Ref PrivateSubnet1CIDR\n      MapPublicIpOnLaunch: false\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-private-subnet-1'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T15:01:04.801610\n\n  # Private Subnet 2\n  PrivateSubnet2:\n    Type: AWS::EC2::Subnet\n    Properties:\n      VpcId: !Ref VPC\n      AvailabilityZone: !Select [1, !GetAZs '']\n      CidrBlock: !Ref PrivateSubnet2CIDR\n      MapPublicIpOnLaunch: false\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-private-subnet-2'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T15:01:04.801610\n\n  # NAT Gateway 1\n  NatGateway1EIP:\n    Type: AWS::EC2::EIP\n    DependsOn: InternetGatewayAttachment\n    Properties:\n      Domain: vpc\n\n  NatGateway1:\n    Type: AWS::EC2::NatGateway\n    Properties:\n      AllocationId: !GetAtt NatGateway1EIP.AllocationId\n      SubnetId: !Ref PublicSubnet1\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-nat-gateway-1'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T15:01:04.801610\n\n  # NAT Gateway 2\n  NatGateway2EIP:\n    Type: AWS::EC2::EIP\n    DependsOn: InternetGatewayAttachment\n    Properties:\n      Domain: vpc\n\n  NatGateway2:\n    Type: AWS::EC2::NatGateway\n    Properties:\n      AllocationId: !GetAtt NatGateway2EIP.AllocationId\n      SubnetId: !Ref PublicSubnet2\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-nat-gateway-2'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T15:01:04.801610\n\n  # Public Route Table\n  PublicRouteTable:\n    Type: AWS::EC2::RouteTable\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-public-route-table'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T15:01:04.801610\n\n  # Public Route\n  PublicRoute:\n    Type: AWS::EC2::Route\n    DependsOn: InternetGatewayAttachment\n    Properties:\n      RouteTableId: !Ref PublicRouteTable\n      DestinationCidrBlock: 0.0.0.0/0\n      GatewayId: !Ref InternetGateway\n\n  # Associate Public Subnet 1 to Public Route Table\n  PublicSubnet1RouteTableAssociation:\n    Type: AWS::EC2::SubnetRouteTableAssociation\n    Properties:\n      SubnetId: !Ref PublicSubnet1\n      RouteTableId: !Ref PublicRouteTable\n\n  # Associate Public Subnet 2 to Public Route Table\n  PublicSubnet2RouteTableAssociation:\n    Type: AWS::EC2::SubnetRouteTableAssociation\n    Properties:\n      SubnetId: !Ref PublicSubnet2\n      RouteTableId: !Ref PublicRouteTable\n\n  # Private Route Table 1\n  PrivateRouteTable1:\n    Type: AWS::EC2::RouteTable\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-private-route-table-1'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T15:01:04.801610\n\n  # Private Route 1\n  PrivateRoute1:\n    Type: AWS::EC2::Route\n    Properties:\n      RouteTableId: !Ref PrivateRouteTable1\n      DestinationCidrBlock: 0.0.0.0/0\n      NatGatewayId: !Ref NatGateway1\n\n  # Associate Private Subnet 1 to Private Route Table 1\n  PrivateSubnet1RouteTableAssociation:\n    Type: AWS::EC2::SubnetRouteTableAssociation\n    Properties:\n      SubnetId: !Ref PrivateSubnet1\n      RouteTableId: !Ref PrivateRouteTable1\n\n  # Private Route Table 2\n  PrivateRouteTable2:\n    Type: AWS::EC2::RouteTable\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-private-route-table-2'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T15:01:04.801610\n\n  # Private Route 2\n  PrivateRoute2:\n    Type: AWS::EC2::Route\n    Properties:\n      RouteTableId: !Ref PrivateRouteTable2\n      DestinationCidrBlock: 0.0.0.0/0\n      NatGatewayId: !Ref NatGateway2\n\n  # Associate Private Subnet 2 to Private Route Table 2\n  PrivateSubnet2RouteTableAssociation:\n    Type: AWS::EC2::SubnetRouteTableAssociation\n    Properties:\n      SubnetId: !Ref PrivateSubnet2\n      RouteTableId: !Ref PrivateRouteTable2\n\n  # Key Management Service (KMS) Key\n  KMSKey:\n    Type: AWS::KMS::Key\n    Properties:\n      Description: KMS key for encryption at rest\n      Enabled: true\n      EnableKeyRotation: true\n      KeyPolicy:\n        Version: '2012-10-17'\n        Id: key-policy\n        Statement:\n          - Sid: Enable IAM User Permissions\n            Effect: Allow\n            Principal:\n              AWS: !Join ['', ['arn:aws:iam::', !Ref 'AWS::AccountId', ':root']]\n            Action: 'kms:*'\n            Resource: '*'\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-kms-key'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T15:01:04.801610\n\n  # Security Group for ALB\n  ALBSecurityGroup:\n    Type: AWS::EC2::SecurityGroup\n    Properties:\n      GroupDescription: Allow HTTP and HTTPS\n      SecurityGroupIngress:\n        - IpProtocol: tcp\n          FromPort: 80\n          ToPort: 80\n          CidrIp: 0.0.0.0/0\n        - IpProtocol: tcp\n          FromPort: 443\n          ToPort: 443\n          CidrIp: 0.0.0.0/0\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-alb-sg'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T15:01:04.801610\n\n  # Security Group for Web Instances\n  WebServerSecurityGroup:\n    Type: AWS::EC2::SecurityGroup\n    Properties:\n      GroupDescription: Allow HTTP from ALB and SSH from office\n      SecurityGroupIngress:\n        - IpProtocol: tcp\n          FromPort: 80\n          ToPort: 80\n          SourceSecurityGroupId: !Ref ALBSecurityGroup\n        - IpProtocol: tcp\n          FromPort: 22\n          ToPort: 22\n          CidrIp: 0.0.0.0/0 # Replace with your office IP range\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-web-sg'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T15:01:04.801610\n\n  # Security Group for RDS\n  RDSSecurityGroup:\n    Type: AWS::EC2::SecurityGroup\n    Properties:\n      GroupDescription: Allow MySQL from Web Instances\n      SecurityGroupIngress:\n        - IpProtocol: tcp\n          FromPort: 3306\n          ToPort: 3306\n          SourceSecurityGroupId: !Ref WebServerSecurityGroup\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-rds-sg'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T15:01:04.801610\n\n  # IAM Role for EC2 Instances\n  EC2InstanceRole:\n    Type: AWS::IAM::Role\n    Properties:\n      AssumeRolePolicyDocument:\n        Version: '2012-10-17'\n        Statement:\n          - Effect: Allow\n            Principal:\n              Service:\n                - ec2.amazonaws.com\n            Action:\n              - 'sts:AssumeRole'\n      ManagedPolicyArns:\n        - 'arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy'\n      Path: /\n      Policies:\n        - PolicyName: CloudWatchLogPermissions\n          PolicyDocument:\n            Version: '2012-10-17'\n            Statement:\n              - Effect: Allow\n                Action:\n                  - 'logs:CreateLogStream'\n                  - 'logs:PutLogEvents'\n                Resource: !Join [':', ['arn:aws:logs', !Ref 'AWS::Region', !Ref 'AWS::AccountId', 'log-group:/aws/ec2/*']]\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-ec2-instance-role'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T15:01:04.801610\n\n  # IAM Instance Profile\n  EC2InstanceProfile:\n    Type: AWS::IAM::InstanceProfile\n    Properties:\n      Roles:\n        - !Ref EC2InstanceRole\n\n  # Launch Configuration\n  LaunchConfiguration:\n    Type: AWS::AutoScaling::LaunchConfiguration\n    Properties:\n      ImageId: ami-0aa7d40eeae50c9a9 # Replace with your AMI ID\n      InstanceType: !Ref EC2InstanceType\n      SecurityGroups:\n        - !Ref WebServerSecurityGroup\n      IamInstanceProfile: !Ref EC2InstanceProfile\n      UserData:\n        Fn",
  "dependencies": [
    "20-network"
  ],
  "estimated_cost": 0.0,
  "created_at": "2025-12-01T15:01:45.995812"
}