{
  "phase_number": 40,
  "phase_name": "database-alb",
  "yaml_content": "```yaml\nAWSTemplateFormatVersion: '2010-09-09'\nDescription: Deploy a web application with load balancer and database\n\nParameters:\n\n  EnvironmentName:\n    Description: An environment name that is prefixed to resource names\n    Type: String\n    Default: dev\n\n  VpcId:\n    Description: ID of the VPC to deploy resources in\n    Type: AWS::EC2::VPC::Id\n\n  EC2KeyPairName:\n    Description: Name of an existing EC2 KeyPair to enable SSH access\n    Type: AWS::EC2::KeyPair::KeyName\n\n  WebServerAMI:\n    Description: AMI ID for the web servers\n    Type: AWS::EC2::Image::Id\n\nResources:\n\n  WebServerRole:\n    Type: AWS::IAM::Role\n    Properties:\n      AssumeRolePolicyDocument:\n        Version: '2012-10-17'\n        Statement:\n          - Effect: Allow\n            Principal:\n              Service: ec2.amazonaws.com\n            Action: 'sts:AssumeRole'\n      ManagedPolicyArns:\n        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore\n      Path: /\n\n  WebServerInstanceProfile:\n    Type: AWS::IAM::InstanceProfile\n    Properties:\n      Path: /\n      Roles:\n        - !Ref WebServerRole\n\n  WebServerSecurityGroup:\n    Type: AWS::EC2::SecurityGroup\n    Properties:\n      GroupDescription: Allow HTTP and SSH\n      SecurityGroupIngress:\n        - IpProtocol: tcp\n          FromPort: 80\n          ToPort: 80\n          SourceSecurityGroupId: !GetAtt LoadBalancerSecurityGroup.GroupId\n        - IpProtocol: tcp\n          FromPort: 22\n          ToPort: 22\n          CidrIp: 0.0.0.0/0\n      VpcId: !Ref VpcId\n\n  WebServerLaunchConfig:\n    Type: AWS::AutoScaling::LaunchConfiguration\n    Metadata:\n      AWS::CloudFormation::Init:\n        config:\n          packages:\n            yum:\n              httpd: []\n          files:\n            /var/www/html/index.html:\n              content: !Sub |\n                <h1>Hello, Welcome to ${EnvironmentName} Environment!</h1>\n          services:\n            sysvinit:\n              httpd:\n                enabled: true\n                ensureRunning: true\n    Properties:\n      ImageId: !Ref WebServerAMI\n      InstanceType: t3.micro\n      KeyName: !Ref EC2KeyPairName\n      SecurityGroups:\n        - !Ref WebServerSecurityGroup\n      IamInstanceProfile: !Ref WebServerInstanceProfile\n      UserData:\n        Fn::Base64:\n          !Sub |\n            #!/bin/bash\n            /opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource WebServerLaunchConfig --region ${AWS::Region}\n            /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource WebServerGroup --region ${AWS::Region}\n\n  WebServerGroup:\n    Type: AWS::AutoScaling::AutoScalingGroup\n    Properties:\n      VPCZoneIdentifier:\n        - !Ref WebServerSubnet1\n        - !Ref WebServerSubnet2\n      LaunchConfigurationName: !Ref WebServerLaunchConfig\n      MinSize: 2\n      MaxSize: 4\n      HealthCheckGracePeriod: 300\n      HealthCheckType: ELB\n      TargetGroupARNs:\n        - !Ref WebServerTargetGroup\n      Tags:\n        - Key: Name\n          Value: !Sub ${EnvironmentName}-WebServer\n          PropagateAtLaunch: true\n        - Key: ManagedBy\n          Value: IAL\n          PropagateAtLaunch: true\n        - Key: CreatedAt\n          Value: '2025-12-01T14:52:46.107382'\n          PropagateAtLaunch: true\n\n  WebServerSubnet1:\n    Type: AWS::EC2::Subnet\n    Properties:\n      VpcId: !Ref VpcId\n      AvailabilityZone: !Select [0, !GetAZs '']\n      CidrBlock: 10.0.1.0/24\n      MapPublicIpOnLaunch: true\n\n  WebServerSubnet2:\n    Type: AWS::EC2::Subnet\n    Properties:\n      VpcId: !Ref VpcId\n      AvailabilityZone: !Select [1, !GetAZs '']\n      CidrBlock: 10.0.2.0/24\n      MapPublicIpOnLaunch: true\n\n  LoadBalancerSecurityGroup:\n    Type: AWS::EC2::SecurityGroup\n    Properties:\n      GroupDescription: Allow HTTP\n      SecurityGroupIngress:\n        - IpProtocol: tcp\n          FromPort: 80\n          ToPort: 80\n          CidrIp: 0.0.0.0/0\n      VpcId: !Ref VpcId\n\n  LoadBalancer:\n    Type: AWS::ElasticLoadBalancingV2::LoadBalancer\n    Properties:\n      Scheme: internet-facing\n      SecurityGroups:\n        - !Ref LoadBalancerSecurityGroup\n      Subnets:\n        - !Ref WebServerSubnet1\n        - !Ref WebServerSubnet2\n\n  WebServerTargetGroup:\n    Type: AWS::ElasticLoadBalancingV2::TargetGroup\n    Properties:\n      HealthCheckPath: /\n      Port: 80\n      Protocol: HTTP\n      TargetType: instance\n      VpcId: !Ref VpcId\n\n  LoadBalancerListener:\n    Type: AWS::ElasticLoadBalancingV2::Listener\n    Properties:\n      DefaultActions:\n        - Type: forward\n          TargetGroupArn: !Ref WebServerTargetGroup\n      LoadBalancerArn: !Ref LoadBalancer\n      Port: 80\n      Protocol: HTTP\n\n  DatabaseSubnetGroup:\n    Type: AWS::RDS::DBSubnetGroup\n    Properties:\n      DBSubnetGroupDescription: Subnets available for the RDS DB\n      SubnetIds:\n        - !Ref DatabaseSubnet1\n        - !Ref DatabaseSubnet2\n\n  DatabaseSubnet1:\n    Type: AWS::EC2::Subnet\n    Properties:\n      VpcId: !Ref VpcId\n      AvailabilityZone: !Select [0, !GetAZs '']\n      CidrBlock: 10.0.3.0/24\n\n  DatabaseSubnet2:\n    Type: AWS::EC2::Subnet\n    Properties:\n      VpcId: !Ref VpcId\n      AvailabilityZone: !Select [1, !GetAZs '']\n      CidrBlock: 10.0.4.0/24\n\n  DatabaseSecurityGroup:\n    Type: AWS::EC2::SecurityGroup\n    Properties:\n      GroupDescription: Allow database access\n      SecurityGroupIngress:\n        - IpProtocol: tcp\n          FromPort: 3306\n          ToPort: 3306\n          SourceSecurityGroupId: !Ref WebServerSecurityGroup\n      VpcId: !Ref VpcId\n\n  Database:\n    Type: AWS::RDS::DBInstance\n    Properties:\n      DBName: webappdb\n      Engine: MySQL\n      EngineVersion: 8.0.31\n      MasterUsername: admin\n      MasterUserPassword: MyPassword1\n      AllocatedStorage: 20\n      MaxAllocatedStorage: 100\n      DBInstanceClass: db.t3.micro\n      StorageType: gp2\n      PubliclyAccessible: false\n      VPCSecurityGroups:\n        - !Ref DatabaseSecurityGroup\n      DBSubnetGroupName: !Ref DatabaseSubnetGroup\n      StorageEncrypted: true\n      KmsKeyId: alias/aws/rds\n      BackupRetentionPeriod: 7\n      MultiAZ: true\n      Tags:\n        - Key: Name\n          Value: !Sub ${EnvironmentName}-Database\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:52:46.107382'\n\nOutputs:\n\n  LoadBalancerDNSName:\n    Description: DNS Name of the load balancer\n    Value: !GetAtt LoadBalancer.DNSName\n    Export:\n      Name: !Sub ${AWS::StackName}-LoadBalancerDNSName\n\n  DatabaseEndpoint:\n    Description: Endpoint for the database\n    Value: !Ref Database\n    Export:\n      Name: !Sub ${AWS::StackName}-DatabaseEndpoint\n```",
  "dependencies": [
    "20-network"
  ],
  "estimated_cost": 0.0,
  "created_at": "2025-12-01T14:53:11.524178"
}