{
  "phase_number": 99,
  "phase_name": "custom",
  "yaml_content": "---\nAWSTemplateFormatVersion: '2010-09-09'\nDescription: Foundation Infrastructure\nParameters:\n  Environment:\n    Type: String\n    Default: production\n    AllowedValues:\n      - production\n      - staging\n      - development\n  VpcCidr:\n    Type: String\n    Default: 10.0.0.0/16\n  PublicSubnet1Cidr:\n    Type: String\n    Default: 10.0.0.0/24\n  PublicSubnet2Cidr:\n    Type: String\n    Default: 10.0.1.0/24\n  PrivateSubnet1Cidr:\n    Type: String\n    Default: 10.0.2.0/24\n  PrivateSubnet2Cidr:\n    Type: String\n    Default: 10.0.3.0/24\n  InstanceType:\n    Type: String\n    Default: t3.micro\n\nMetadata:\n  AWS::CloudFormation::Interface:\n    ParameterGroups:\n      - Label:\n          default: Environment Configuration\n        Parameters:\n          - Environment\n      - Label:\n          default: Network Configuration\n        Parameters:\n          - VpcCidr\n          - PublicSubnet1Cidr\n          - PublicSubnet2Cidr\n          - PrivateSubnet1Cidr\n          - PrivateSubnet2Cidr\n      - Label:\n          default: Instance Configuration\n        Parameters:\n          - InstanceType\n\nResources:\n  # KMS Key for Encryption at Rest\n  EncryptionKey:\n    Type: AWS::KMS::Key\n    Properties:\n      Description: KMS key for encrypting resources\n      EnableKeyRotation: true\n      Enabled: true\n      KeyPolicy:\n        Version: '2012-10-17'\n        Id: key-policy\n        Statement:\n          - Sid: Allow administration of the key\n            Effect: Allow\n            Principal:\n              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'\n            Action:\n              - 'kms:*'\n            Resource: '*'\n\n  # VPC\n  VPC:\n    Type: AWS::EC2::VPC\n    Properties:\n      CidrBlock: !Ref VpcCidr\n      EnableDnsHostnames: true\n      EnableDnsSupport: true\n      InstanceTenancy: default\n      Tags:\n        - Key: Name\n          Value: !Sub '${Environment}-vpc'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-11-18T19:46:56.424876\n\n  # Internet Gateway\n  InternetGateway:\n    Type: AWS::EC2::InternetGateway\n    Properties:\n      Tags:\n        - Key: Name\n          Value: !Sub '${Environment}-igw'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-11-18T19:46:56.424876\n\n  # Internet Gateway Attachment\n  InternetGatewayAttachment:\n    Type: AWS::EC2::VPCGatewayAttachment\n    Properties:\n      InternetGatewayId: !Ref InternetGateway\n      VpcId: !Ref VPC\n\n  # Public Subnets\n  PublicSubnet1:\n    Type: AWS::EC2::Subnet\n    Properties:\n      AvailabilityZone: !Select [0, !GetAZs '']\n      CidrBlock: !Ref PublicSubnet1Cidr\n      MapPublicIpOnLaunch: true\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${Environment}-public-subnet-1'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-11-18T19:46:56.424876\n\n  PublicSubnet2:\n    Type: AWS::EC2::Subnet\n    Properties:\n      AvailabilityZone: !Select [1, !GetAZs '']\n      CidrBlock: !Ref PublicSubnet2Cidr\n      MapPublicIpOnLaunch: true\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${Environment}-public-subnet-2'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-11-18T19:46:56.424876\n\n  # Private Subnets\n  PrivateSubnet1:\n    Type: AWS::EC2::Subnet\n    Properties:\n      AvailabilityZone: !Select [0, !GetAZs '']\n      CidrBlock: !Ref PrivateSubnet1Cidr\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${Environment}-private-subnet-1'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-11-18T19:46:56.424876\n\n  PrivateSubnet2:\n    Type: AWS::EC2::Subnet\n    Properties:\n      AvailabilityZone: !Select [1, !GetAZs '']\n      CidrBlock: !Ref PrivateSubnet2Cidr\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${Environment}-private-subnet-2'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-11-18T19:46:56.424876\n\n  # NAT Gateway\n  NatGateway1EIP:\n    Type: AWS::EC2::EIP\n    DependsOn: InternetGatewayAttachment\n    Properties:\n      Domain: vpc\n\n  NatGateway2EIP:\n    Type: AWS::EC2::EIP\n    DependsOn: InternetGatewayAttachment\n    Properties:\n      Domain: vpc\n\n  NatGateway1:\n    Type: AWS::EC2::NatGateway\n    Properties:\n      AllocationId: !GetAtt NatGateway1EIP.AllocationId\n      SubnetId: !Ref PublicSubnet1\n      Tags:\n        - Key: Name\n          Value: !Sub '${Environment}-nat-gateway-1'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-11-18T19:46:56.424876\n\n  NatGateway2:\n    Type: AWS::EC2::NatGateway\n    Properties:\n      AllocationId: !GetAtt NatGateway2EIP.AllocationId\n      SubnetId: !Ref PublicSubnet2\n      Tags:\n        - Key: Name\n          Value: !Sub '${Environment}-nat-gateway-2'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-11-18T19:46:56.424876\n\n  # Route Tables\n  PublicRouteTable:\n    Type: AWS::EC2::RouteTable\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${Environment}-public-route-table'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-11-18T19:46:56.424876\n\n  PublicRoute:\n    Type: AWS::EC2::Route\n    DependsOn: InternetGatewayAttachment\n    Properties:\n      RouteTableId: !Ref PublicRouteTable\n      DestinationCidrBlock: 0.0.0.0/0\n      GatewayId: !Ref InternetGateway\n\n  PublicSubnet1RouteTableAssociation:\n    Type: AWS::EC2::SubnetRouteTableAssociation\n    Properties:\n      RouteTableId: !Ref PublicRouteTable\n      SubnetId: !Ref PublicSubnet1\n\n  PublicSubnet2RouteTableAssociation:\n    Type: AWS::EC2::SubnetRouteTableAssociation\n    Properties:\n      RouteTableId: !Ref PublicRouteTable\n      SubnetId: !Ref PublicSubnet2\n\n  PrivateRouteTable1:\n    Type: AWS::EC2::RouteTable\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${Environment}-private-route-table-1'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-11-18T19:46:56.424876\n\n  PrivateRoute1:\n    Type: AWS::EC2::Route\n    Properties:\n      RouteTableId: !Ref PrivateRouteTable1\n      DestinationCidrBlock: 0.0.0.0/0\n      NatGatewayId: !Ref NatGateway1\n\n  PrivateSubnet1RouteTableAssociation:\n    Type: AWS::EC2::SubnetRouteTableAssociation\n    Properties:\n      RouteTableId: !Ref PrivateRouteTable1\n      SubnetId: !Ref PrivateSubnet1\n\n  PrivateRouteTable2:\n    Type: AWS::EC2::RouteTable\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${Environment}-private-route-table-2'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-11-18T19:46:56.424876\n\n  PrivateRoute2:\n    Type: AWS::EC2::Route\n    Properties:\n      RouteTableId: !Ref PrivateRouteTable2\n      DestinationCidrBlock: 0.0.0.0/0\n      NatGatewayId: !Ref NatGateway2\n\n  PrivateSubnet2RouteTableAssociation:\n    Type: AWS::EC2::SubnetRouteTableAssociation\n    Properties:\n      RouteTableId: !Ref PrivateRouteTable2\n      SubnetId: !Ref PrivateSubnet2\n\n  # Security Groups\n  PublicSecurityGroup:\n    Type: AWS::EC2::SecurityGroup\n    Properties:\n      GroupDescription: Allow only HTTPS traffic\n      SecurityGroupIngress:\n        - IpProtocol: tcp\n          FromPort: 443\n          ToPort: 443\n          CidrIp: 0.0.0.0/0\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${Environment}-public-sg'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-11-18T19:46:56.424876\n\n  PrivateSecurityGroup:\n    Type: AWS::EC2::SecurityGroup\n    Properties:\n      GroupDescription: Allow traffic from public SG\n      SecurityGroupIngress:\n        - IpProtocol: -1\n          SourceSecurityGroupId: !Ref PublicSecurityGroup\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${Environment}-private-sg'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-11-18T19:46:56.424876\n\n  # IAM Role for EC2\n  EC2Role:\n    Type: AWS::IAM::Role\n    Properties:\n      AssumeRolePolicyDocument:\n        Version: '2012-10-17'\n        Statement:\n          - Effect: Allow\n            Principal:\n              Service:\n                - ec2.amazonaws.com\n            Action:\n              - 'sts:AssumeRole'\n      ManagedPolicyArns:\n        - 'arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM'\n      Path: /\n      Policies:\n        - PolicyName: LoggingPolicy\n          PolicyDocument:\n            Version: '2012-10-17'\n            Statement:\n              - Effect: Allow\n                Action:\n                  - 'logs:CreateLogGroup'\n                  - 'logs:CreateLogStream'\n                  - 'logs:PutLogEvents'\n                  - 'logs:DescribeLogStreams'\n                Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/ec2/*'\n\n  # CloudWatch Log Group\n  LogGroup:\n    Type: AWS::Logs::LogGroup\n    Properties:\n      LogGroupName: !Sub '${Environment}-ec2-logs'\n      RetentionInDays: 30\n\n  # Instance Monitoring\n  InstanceMonitoring:\n    Type: AWS::CloudWatch::Alarm\n    Properties:\n      AlarmDescription: CPU or memory utilization is high\n      Namespace: AWS/EC2\n      MetricName: CPUUtilization\n      Dimensions:\n        - Name: InstanceId\n          Value: !Ref EC2Instance\n      Statistic: Average\n      Period: 60\n      EvaluationPeriods: 5\n      Threshold: 80\n      ComparisonOperator: GreaterThanThreshold\n      AlarmActions:\n        - !Ref OperatorEmail\n      TreatMissingData: notBreaching\n\n  # EC2 Instance\n  EC2Instance:\n    Type: AWS::EC2::Instance\n    Properties:\n      ImageId: ami-0cff7528ff583bf9a  # Amazon Linux 2 AMI\n      InstanceType: !Ref InstanceType\n      KeyName: my-key-pair  # Enter your key pair name\n      IamInstanceProfile: !Ref EC2InstanceProfile\n      SecurityGroupIds:\n        - !Ref PrivateSecurityGroup\n      SubnetId: !Ref PrivateSubnet1\n      UserData:\n        Fn::Base64:\n          !Sub |\n            #!/bin/bash\n            yum install -y awslogs\n            systemctl start awslogsd\n            systemctl enable awslogsd.service\n      Monitoring: true\n      BlockDeviceMappings:\n        - DeviceName: /dev/xvda\n          Ebs:\n            VolumeType: gp2\n            VolumeSize: 8\n            Encrypted: true\n            KmsKeyId: !Ref EncryptionKey\n      Tags:\n        - Key: Name\n          Value: !Sub '${Environment}-ec2'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-11-18T19:46:56.424876\n\nOutputs:\n  VpcId:\n    Description: The ID of the VPC\n    Value: !Ref VPC\n    Export:\n      Name: !Sub '${Environment}-vpc-id'\n\n  PublicSubnets:\n    Description: A list of public subnets\n    Value: !Join [',', [!Ref PublicSubnet1, !Ref PublicSubnet2]]\n    Export:\n      Name: !Sub '${Environment}-public-subnets'\n\n  PrivateSubnets:\n    Description: A list of private subnets\n    Value: !Join [',', [!Ref PrivateSubnet1, !Ref PrivateSubnet2]]\n    Export:\n      Name: !Sub '${Environment}-private-subnets'\n\n  PublicSecurityGroupId:\n    Description: The ID of the public security group\n    Value: !Ref PublicSecurityGroup\n    Export:\n      Name: !Sub '${Environment}-public-sg-id'\n\n  PrivateSecurityGroupId:\n    Description: The ID of the private security group\n    Value: !Ref PrivateSecurityGroup\n    Export:\n      Name: !Sub '${Environment}-private-sg-id'\n\n  EC2InstanceId:\n    Description: The ID of the EC2 instance\n    Value: !Ref EC2Instance\n    Export:\n      Name: !Sub '${Environment}-ec2-instance-",
  "dependencies": [
    "20-network"
  ],
  "estimated_cost": 0.0,
  "created_at": "2025-11-18T19:47:40.838404"
}