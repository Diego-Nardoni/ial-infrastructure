{
  "phase_number": 50,
  "phase_name": "storage",
  "yaml_content": "```yaml\nAWSTemplateFormatVersion: '2010-09-09'\nDescription: CloudFormation template to list S3 buckets\n\nParameters:\n  KmsKeyArn:\n    Type: AWS::SSM::Parameter::Value<AWS::EC2::KeyPair::KeyName>\n    Default: /aws/reference/secretsmanager/my-kms-key-arn\n\nResources:\n\n  CloudWatchLogGroup:\n    Type: AWS::Logs::LogGroup\n    Properties:\n      LogGroupName: !Sub '/aws/lambda/${ListBucketsFunction}'\n      RetentionInDays: 7\n\n  ListBucketsFunction:\n    Type: AWS::Lambda::Function\n    Properties:\n      FunctionName: list-s3-buckets\n      Runtime: python3.9\n      Handler: index.lambda_handler\n      Role: !GetAtt LambdaExecutionRole.Arn\n      Code:\n        ZipFile: |\n          import boto3\n          import json\n\n          s3 = boto3.client('s3')\n\n          def lambda_handler(event, context):\n              buckets = [bucket['Name'] for bucket in s3.list_buckets()['Buckets']]\n              return {\n                  'statusCode': 200,\n                  'body': json.dumps(buckets)\n              }\n      MemorySize: 128\n      Timeout: 30\n      VpcConfig:\n        SecurityGroupIds:\n          - !Ref LambdaSecurityGroup\n        SubnetIds:\n          - !Ref PrivateSubnet1\n          - !Ref PrivateSubnet2\n      Environment:\n        Variables:\n          KMS_KEY_ARN: !Ref KmsKeyArn\n      LogGroupName: !Ref CloudWatchLogGroup\n\n  LambdaExecutionRole:\n    Type: AWS::IAM::Role\n    Properties:\n      AssumeRolePolicyDocument:\n        Version: '2012-10-17'\n        Statement:\n          - Effect: Allow\n            Principal:\n              Service:\n                - lambda.amazonaws.com\n            Action:\n              - 'sts:AssumeRole'\n      ManagedPolicyArns:\n        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole\n        - arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess\n      Policies:\n        - PolicyName: KMSDecryptionPolicy\n          PolicyDocument:\n            Version: '2012-10-17'\n            Statement:\n              - Effect: Allow\n                Action:\n                  - 'kms:Decrypt'\n                Resource: !Ref KmsKeyArn\n\n  LambdaSecurityGroup:\n    Type: AWS::EC2::SecurityGroup\n    Properties:\n      GroupDescription: Allow Lambda function access\n      SecurityGroupIngress: []\n      VpcId: !Ref VPC\n\n  PrivateSubnet1:\n    Type: AWS::EC2::Subnet\n    Properties:\n      AvailabilityZone: !Select [0, !GetAZs '']\n      CidrBlock: 10.0.1.0/24\n      MapPublicIpOnLaunch: false\n      VpcId: !Ref VPC\n\n  PrivateSubnet2:\n    Type: AWS::EC2::Subnet\n    Properties:\n      AvailabilityZone: !Select [1, !GetAZs '']\n      CidrBlock: 10.0.2.0/24\n      MapPublicIpOnLaunch: false\n      VpcId: !Ref VPC\n\n  VPC:\n    Type: AWS::EC2::VPC\n    Properties:\n      CidrBlock: 10.0.0.0/16\n      EnableDnsHostnames: true\n      EnableDnsSupport: true\n      InstanceTenancy: default\n      Tags:\n        - Key: Name\n          Value: list-buckets-vpc\n\nOutputs:\n\n  ListBucketsFunction:\n    Description: Lambda function to list S3 buckets\n    Value: !Ref ListBucketsFunction\n    Export:\n      Name: !Sub '${AWS::StackName}-ListBucketsFunction'\n\nMetadata:\n  AWS::CloudFormation::Interface:\n    ParameterGroups:\n      - Label:\n          default: Security Configuration\n        Parameters:\n          - KmsKeyArn\n    ParameterLabels:\n      KmsKeyArn:\n        default: KMS Key ARN\n\n```",
  "dependencies": [
    "20-network"
  ],
  "estimated_cost": 0.0,
  "created_at": "2025-12-01T20:32:28.094388"
}