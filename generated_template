{
  "phase_number": 40,
  "phase_name": "database-alb",
  "yaml_content": "```yaml\nAWSTemplateFormatVersion: '2010-09-09'\nDescription: Web application with load balancer and database\n\nParameters:\n\n  EnvironmentName:\n    Description: An environment name that is prefixed to resource names\n    Type: String\n\n  DatabasePassword:\n    Description: Password for the database\n    Type: String\n    NoEcho: true\n\n  VPCCidrBlock:\n    Description: The CIDR block for the VPC\n    Type: String\n    Default: 10.0.0.0/16\n\n  PublicSubnet1CidrBlock:\n    Description: The CIDR block for the public subnet 1\n    Type: String\n    Default: 10.0.0.0/24\n\n  PublicSubnet2CidrBlock:\n    Description: The CIDR block for the public subnet 2\n    Type: String\n    Default: 10.0.1.0/24\n\n  PrivateSubnet1CidrBlock:\n    Description: The CIDR block for the private subnet 1\n    Type: String\n    Default: 10.0.2.0/24\n\n  PrivateSubnet2CidrBlock:\n    Description: The CIDR block for the private subnet 2\n    Type: String\n    Default: 10.0.3.0/24\n\nResources:\n\n  VPC:\n    Type: AWS::EC2::VPC\n    Properties:\n      CidrBlock: !Ref VPCCidrBlock\n      EnableDnsHostnames: true\n      EnableDnsSupport: true\n      InstanceTenancy: default\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-VPC'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:36:56.290649'\n\n  InternetGateway:\n    Type: AWS::EC2::InternetGateway\n    Properties:\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-IGW'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:36:56.290649'\n\n  InternetGatewayAttachment:\n    Type: AWS::EC2::VPCGatewayAttachment\n    Properties:\n      VpcId: !Ref VPC\n      InternetGatewayId: !Ref InternetGateway\n\n  PublicSubnet1:\n    Type: AWS::EC2::Subnet\n    Properties:\n      VpcId: !Ref VPC\n      AvailabilityZone: !Select [0, !GetAZs '']\n      CidrBlock: !Ref PublicSubnet1CidrBlock\n      MapPublicIpOnLaunch: true\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-PublicSubnet1'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:36:56.290649'\n\n  PublicSubnet2:\n    Type: AWS::EC2::Subnet\n    Properties:\n      VpcId: !Ref VPC\n      AvailabilityZone: !Select [1, !GetAZs '']\n      CidrBlock: !Ref PublicSubnet2CidrBlock\n      MapPublicIpOnLaunch: true\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-PublicSubnet2'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:36:56.290649'\n\n  PrivateSubnet1:\n    Type: AWS::EC2::Subnet\n    Properties:\n      VpcId: !Ref VPC\n      AvailabilityZone: !Select [0, !GetAZs '']\n      CidrBlock: !Ref PrivateSubnet1CidrBlock\n      MapPublicIpOnLaunch: false\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-PrivateSubnet1'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:36:56.290649'\n\n  PrivateSubnet2:\n    Type: AWS::EC2::Subnet\n    Properties:\n      VpcId: !Ref VPC\n      AvailabilityZone: !Select [1, !GetAZs '']\n      CidrBlock: !Ref PrivateSubnet2CidrBlock\n      MapPublicIpOnLaunch: false\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-PrivateSubnet2'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:36:56.290649'\n\n  NatGatewayEIP1:\n    Type: AWS::EC2::EIP\n    DependsOn: InternetGatewayAttachment\n    Properties:\n      Domain: vpc\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-NatGatewayEIP1'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:36:56.290649'\n\n  NatGatewayEIP2:\n    Type: AWS::EC2::EIP\n    DependsOn: InternetGatewayAttachment\n    Properties:\n      Domain: vpc\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-NatGatewayEIP2'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:36:56.290649'\n\n  NatGateway1:\n    Type: AWS::EC2::NatGateway\n    Properties:\n      AllocationId: !GetAtt NatGatewayEIP1.AllocationId\n      SubnetId: !Ref PublicSubnet1\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-NatGateway1'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:36:56.290649'\n\n  NatGateway2:\n    Type: AWS::EC2::NatGateway\n    Properties:\n      AllocationId: !GetAtt NatGatewayEIP2.AllocationId\n      SubnetId: !Ref PublicSubnet2\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-NatGateway2'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:36:56.290649'\n\n  PublicRouteTable:\n    Type: AWS::EC2::RouteTable\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-PublicRouteTable'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:36:56.290649'\n\n  PrivateRouteTable1:\n    Type: AWS::EC2::RouteTable\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-PrivateRouteTable1'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:36:56.290649'\n\n  PrivateRouteTable2:\n    Type: AWS::EC2::RouteTable\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-PrivateRouteTable2'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:36:56.290649'\n\n  PublicRoute:\n    Type: AWS::EC2::Route\n    DependsOn: InternetGatewayAttachment\n    Properties:\n      RouteTableId: !Ref PublicRouteTable\n      DestinationCidrBlock: 0.0.0.0/0\n      GatewayId: !Ref InternetGateway\n\n  PrivateRoute1:\n    Type: AWS::EC2::Route\n    Properties:\n      RouteTableId: !Ref PrivateRouteTable1\n      DestinationCidrBlock: 0.0.0.0/0\n      NatGatewayId: !Ref NatGateway1\n\n  PrivateRoute2:\n    Type: AWS::EC2::Route\n    Properties:\n      RouteTableId: !Ref PrivateRouteTable2\n      DestinationCidrBlock: 0.0.0.0/0\n      NatGatewayId: !Ref NatGateway2\n\n  PublicSubnetRouteTableAssociation1:\n    Type: AWS::EC2::SubnetRouteTableAssociation\n    Properties:\n      SubnetId: !Ref PublicSubnet1\n      RouteTableId: !Ref PublicRouteTable\n\n  PublicSubnetRouteTableAssociation2:\n    Type: AWS::EC2::SubnetRouteTableAssociation\n    Properties:\n      SubnetId: !Ref PublicSubnet2\n      RouteTableId: !Ref PublicRouteTable\n\n  PrivateSubnetRouteTableAssociation1:\n    Type: AWS::EC2::SubnetRouteTableAssociation\n    Properties:\n      SubnetId: !Ref PrivateSubnet1\n      RouteTableId: !Ref PrivateRouteTable1\n\n  PrivateSubnetRouteTableAssociation2:\n    Type: AWS::EC2::SubnetRouteTableAssociation\n    Properties:\n      SubnetId: !Ref PrivateSubnet2\n      RouteTableId: !Ref PrivateRouteTable2\n\n  DatabaseSecurityGroup:\n    Type: AWS::EC2::SecurityGroup\n    Properties:\n      GroupDescription: Allow database access\n      VpcId: !Ref VPC\n      SecurityGroupIngress:\n        - IpProtocol: tcp\n          FromPort: 5432\n          ToPort: 5432\n          SourceSecurityGroupId: !Ref WebServerSecurityGroup\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-DatabaseSecurityGroup'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:36:56.290649'\n\n  WebServerSecurityGroup:\n    Type: AWS::EC2::SecurityGroup\n    Properties:\n      GroupDescription: Allow web access\n      VpcId: !Ref VPC\n      SecurityGroupIngress:\n        - IpProtocol: tcp\n          FromPort: 80\n          ToPort: 80\n          CidrIp: 0.0.0.0/0\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-WebServerSecurityGroup'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:36:56.290649'\n\n  DatabaseSubnetGroup:\n    Type: AWS::RDS::DBSubnetGroup\n    Properties:\n      DBSubnetGroupDescription: Subnets available for the RDS DB\n      SubnetIds:\n        - !Ref PrivateSubnet1\n        - !Ref PrivateSubnet2\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-DatabaseSubnetGroup'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:36:56.290649'\n\n  DatabaseEncryptionKey:\n    Type: AWS::KMS::Key\n    Properties:\n      Description: KMS key to encrypt RDS database\n      EnableKeyRotation: true\n      KeyPolicy:\n        Version: '2012-10-17'\n        Statement:\n          - Sid: Enable IAM User Permissions\n            Effect: Allow\n            Principal:\n              AWS: !Join [':', ['arn:aws:iam:', !Ref 'AWS::AccountId', 'root']]\n            Action: 'kms:*'\n            Resource: '*'\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-DatabaseEncryptionKey'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:36:56.290649'\n\n  DatabaseInstance:\n    Type: AWS::RDS::DBInstance\n    Properties:\n      DBName: !Ref 'AWS::StackName'\n      Engine: postgres\n      EngineVersion: 14.5\n      MasterUsername: root\n      MasterUserPassword: !Ref DatabasePassword\n      DBInstanceClass: db.t3.micro\n      AllocatedStorage: 20\n      StorageType: gp2\n      StorageEncrypted: true\n      KmsKeyId: !Ref DatabaseEncryptionKey\n      VPCSecurityGroupIds:\n        - !Ref DatabaseSecurityGroup\n      DBSubnetGroupName: !Ref DatabaseSubnetGroup\n      PubliclyAccessible: false\n      MultiAZ: true\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-Database'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:36:56.290649'\n\n  WebServerInstanceProfile:\n    Type: AWS::IAM::InstanceProfile\n    Properties:\n      Path: /\n      Roles:\n        - !Ref WebServerRole\n\n  WebServerRole:\n    Type: AWS::IAM::Role\n    Properties:\n      AssumeRolePolicyDocument:\n        Version: '2012-10-17'\n        Statement:\n          - Effect: Allow\n            Principal:\n              Service:\n                - ec2.amazonaws.com\n            Action:\n              - 'sts:AssumeRole'\n      ManagedPolicyArns:\n        - arn:aws:iam::aws:policy/CloudWatchLogsFullAccess\n      Path: /\n      Policies:\n        - PolicyName: AllowDatabaseAccess\n          PolicyDocument:\n            Version: '2012-10-17'\n            Statement:\n              - Effect: Allow\n                Action:\n                  - rds-db:connect\n                Resource:\n                  - !Join ['', ['arn:aws:rds-db:', !Ref 'AWS::Region', ':', !Ref 'AWS::AccountId', ':dbuser:/', !Ref 'DatabaseInstance', '/root']]\n              - Effect: Allow\n                Action:\n                  - 'ec2:CreateNetworkInterface'\n                  - 'ec2:DescribeNetworkInterfaces'\n                Resource: '*'\n\n  WebServerLaunchConfig:\n    Type: AWS::AutoScaling::LaunchConfiguration\n    Properties:\n      ImageId: ami-0aa7d40eeae50c9a9 # Amazon Linux 2\n      InstanceType: t2.micro\n      SecurityGroups:\n        - !Ref WebServerSecurityGroup\n      IamInstanceProfile: !Ref WebServerInstanceProfile\n      UserData:\n        Fn::Base64:\n          !Sub |\n            #!/bin/bash\n            yum update -y\n            yum install -y httpd\n            systemctl start httpd\n            systemctl enable httpd\n\n  WebServerGroup:\n    Type: AWS::AutoScaling::AutoScalingGroup\n    Properties:\n      VPCZoneIdentifier:\n        - !Ref PrivateSubnet1\n        - !Ref PrivateSubnet2\n      LaunchConfigurationName: !Ref Web",
  "dependencies": [
    "20-network"
  ],
  "estimated_cost": 0.0,
  "created_at": "2025-12-01T14:37:37.965275"
}