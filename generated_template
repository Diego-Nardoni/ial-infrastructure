{
  "phase_number": 40,
  "phase_name": "database-alb",
  "yaml_content": "---\nAWSTemplateFormatVersion: '2010-09-09'\nDescription: 'Web Application with Load Balancer, Database, and Best Practices'\n\nParameters:\n\n  EnvironmentName:\n    Description: 'An environment name that will be prefixed to resource names'\n    Type: String\n    Default: production\n\n  VPCCidrBlock:\n    Description: 'CIDR block for the VPC'\n    Type: String\n    Default: 10.0.0.0/16\n\n  PublicSubnet1CidrBlock:\n    Description: 'CIDR block for Public Subnet 1'\n    Type: String\n    Default: 10.0.0.0/24\n\n  PublicSubnet2CidrBlock:\n    Description: 'CIDR block for Public Subnet 2'\n    Type: String\n    Default: 10.0.1.0/24\n\n  PrivateSubnet1CidrBlock:\n    Description: 'CIDR block for Private Subnet 1'\n    Type: String\n    Default: 10.0.2.0/24\n\n  PrivateSubnet2CidrBlock:\n    Description: 'CIDR block for Private Subnet 2'\n    Type: String\n    Default: 10.0.3.0/24\n\n  InstanceType:\n    Description: 'Instance type for EC2 instances'\n    Type: String\n    Default: t3.micro\n    AllowedValues:\n      - t3.micro\n      - t3.small\n      - t3.medium\n\n  DBAllocatedStorage:\n    Description: 'Allocated storage for the RDS instance (GB)'\n    Type: Number\n    Default: 20\n    MinValue: 20\n    MaxValue: 1000\n\n  DBInstanceClass:\n    Description: 'Instance class for the RDS instance'\n    Type: String\n    Default: db.t3.micro\n    AllowedValues:\n      - db.t3.micro\n      - db.t3.small\n      - db.t3.medium\n\nResources:\n\n  #######\n  # VPC #\n  #######\n\n  VPC:\n    Type: 'AWS::EC2::VPC'\n    Properties:\n      CidrBlock: !Ref VPCCidrBlock\n      EnableDnsHostnames: true\n      EnableDnsSupport: true\n      InstanceTenancy: default\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-VPC'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T14:43:59.511373\n\n  #############\n  # Subnets #\n  #############\n\n  PublicSubnet1:\n    Type: 'AWS::EC2::Subnet'\n    Properties:\n      VpcId: !Ref VPC\n      AvailabilityZone: !Select [ 0, !GetAZs '' ]\n      CidrBlock: !Ref PublicSubnet1CidrBlock\n      MapPublicIpOnLaunch: true\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-Public-Subnet-1'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T14:43:59.511373\n\n  PublicSubnet2:\n    Type: 'AWS::EC2::Subnet'\n    Properties:\n      VpcId: !Ref VPC\n      AvailabilityZone: !Select [ 1, !GetAZs '' ]\n      CidrBlock: !Ref PublicSubnet2CidrBlock\n      MapPublicIpOnLaunch: true\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-Public-Subnet-2'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T14:43:59.511373\n\n  PrivateSubnet1:\n    Type: 'AWS::EC2::Subnet'\n    Properties:\n      VpcId: !Ref VPC\n      AvailabilityZone: !Select [ 0, !GetAZs '' ]\n      CidrBlock: !Ref PrivateSubnet1CidrBlock\n      MapPublicIpOnLaunch: false\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-Private-Subnet-1'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T14:43:59.511373\n\n  PrivateSubnet2:\n    Type: 'AWS::EC2::Subnet'\n    Properties:\n      VpcId: !Ref VPC\n      AvailabilityZone: !Select [ 1, !GetAZs '' ]\n      CidrBlock: !Ref PrivateSubnet2CidrBlock\n      MapPublicIpOnLaunch: false\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-Private-Subnet-2'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T14:43:59.511373\n\n  ####################\n  # Internet Gateway #\n  ####################\n\n  InternetGateway:\n    Type: 'AWS::EC2::InternetGateway'\n    Properties:\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-IGW'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T14:43:59.511373\n\n  InternetGatewayAttachment:\n    Type: 'AWS::EC2::VPCGatewayAttachment'\n    Properties:\n      VpcId: !Ref VPC\n      InternetGatewayId: !Ref InternetGateway\n\n  ##################\n  # Elastic IPs #\n  ##################\n\n  NATGatewayEIP1:\n    Type: 'AWS::EC2::EIP'\n    Properties:\n      Domain: vpc\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-NATGW-EIP-1'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T14:43:59.511373\n\n  NATGatewayEIP2:\n    Type: 'AWS::EC2::EIP'\n    Properties:\n      Domain: vpc\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-NATGW-EIP-2'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T14:43:59.511373\n\n  ################\n  # NAT Gateways #\n  ################\n\n  NATGateway1:\n    Type: 'AWS::EC2::NatGateway'\n    Properties:\n      AllocationId: !GetAtt NATGatewayEIP1.AllocationId\n      SubnetId: !Ref PublicSubnet1\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-NATGW-1'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T14:43:59.511373\n\n  NATGateway2:\n    Type: 'AWS::EC2::NatGateway'\n    Properties:\n      AllocationId: !GetAtt NATGatewayEIP2.AllocationId\n      SubnetId: !Ref PublicSubnet2\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-NATGW-2'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T14:43:59.511373\n\n  ###############\n  # Route Tables #\n  ###############\n\n  PublicRouteTable:\n    Type: 'AWS::EC2::RouteTable'\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-Public-RT'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T14:43:59.511373\n\n  PrivateRouteTable1:\n    Type: 'AWS::EC2::RouteTable'\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-Private-RT-1'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T14:43:59.511373\n\n  PrivateRouteTable2:\n    Type: 'AWS::EC2::RouteTable'\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-Private-RT-2'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T14:43:59.511373\n\n  ###############\n  # Route Table Associations #\n  ###############\n\n  PublicSubnet1RouteTableAssociation:\n    Type: 'AWS::EC2::SubnetRouteTableAssociation'\n    Properties:\n      SubnetId: !Ref PublicSubnet1\n      RouteTableId: !Ref PublicRouteTable\n\n  PublicSubnet2RouteTableAssociation:\n    Type: 'AWS::EC2::SubnetRouteTableAssociation'\n    Properties:\n      SubnetId: !Ref PublicSubnet2\n      RouteTableId: !Ref PublicRouteTable\n\n  PrivateSubnet1RouteTableAssociation:\n    Type: 'AWS::EC2::SubnetRouteTableAssociation'\n    Properties:\n      SubnetId: !Ref PrivateSubnet1\n      RouteTableId: !Ref PrivateRouteTable1\n\n  PrivateSubnet2RouteTableAssociation:\n    Type: 'AWS::EC2::SubnetRouteTableAssociation'\n    Properties:\n      SubnetId: !Ref PrivateSubnet2\n      RouteTableId: !Ref PrivateRouteTable2\n\n  ###############\n  # Routes #\n  ###############\n\n  PublicRouteToInternet:\n    Type: 'AWS::EC2::Route'\n    Properties:\n      RouteTableId: !Ref PublicRouteTable\n      DestinationCidrBlock: 0.0.0.0/0\n      GatewayId: !Ref InternetGateway\n\n  PrivateRoute1ToNATGateway:\n    Type: 'AWS::EC2::Route'\n    Properties:\n      RouteTableId: !Ref PrivateRouteTable1\n      DestinationCidrBlock: 0.0.0.0/0\n      NatGatewayId: !Ref NATGateway1\n\n  PrivateRoute2ToNATGateway:\n    Type: 'AWS::EC2::Route'\n    Properties:\n      RouteTableId: !Ref PrivateRouteTable2\n      DestinationCidrBlock: 0.0.0.0/0\n      NatGatewayId: !Ref NATGateway2\n\n  ##############\n  # KMS Key #\n  ##############\n\n  KMSKey:\n    Type: 'AWS::KMS::Key'\n    Properties:\n      Description: 'KMS Key for data encryption'\n      KeyPolicy:\n        Version: '2012-10-17'\n        Id: 'key-policy-1'\n        Statement:\n          - Sid: 'Enable IAM User Permissions'\n            Effect: Allow\n            Principal:\n              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'\n            Action: 'kms:*'\n            Resource: '*'\n    DeletionPolicy: Retain\n\n  ################\n  # Security Group for ALB #\n  ################\n\n  ALBSecurityGroup:\n    Type: 'AWS::EC2::SecurityGroup'\n    Properties:\n      GroupDescription: 'Security Group for ALB'\n      VpcId: !Ref VPC\n      SecurityGroupIngress:\n        - IpProtocol: tcp\n          FromPort: 80\n          ToPort: 80\n          CidrIp: 0.0.0.0/0\n        - IpProtocol: tcp\n          FromPort: 443\n          ToPort: 443\n          CidrIp: 0.0.0.0/0\n      SecurityGroupEgress:\n        - IpProtocol: '-1'\n          FromPort: -1\n          ToPort: -1\n          DestinationSecurityGroupId: !Ref WebServerSecurityGroup\n\n  ################\n  # Security Group for Web Servers #\n  ################\n\n  WebServerSecurityGroup:\n    Type: 'AWS::EC2::SecurityGroup'\n    Properties:\n      GroupDescription: 'Security Group for Web Servers'\n      VpcId: !Ref VPC\n      SecurityGroupIngress:\n        - IpProtocol: tcp\n          FromPort: 80\n          ToPort: 80\n          SourceSecurityGroupId: !Ref ALBSecurityGroup\n        - IpProtocol: tcp\n          FromPort: 22\n          ToPort: 22\n          CidrIp: 0.0.0.0/0\n      SecurityGroupEgress:\n        - IpProtocol: '-1'\n          FromPort: -1\n          ToPort: -1\n          DestinationSecurityGroupId: !Ref DBSecurityGroup\n\n  ################\n  # Security Group for RDS #\n  ################\n\n  DBSecurityGroup:\n    Type: 'AWS::EC2::SecurityGroup'\n    Properties:\n      GroupDescription: 'Security Group for RDS'\n      VpcId: !Ref VPC\n      SecurityGroupIngress:\n        - IpProtocol: tcp\n          FromPort: 3306\n          ToPort: 3306\n          SourceSecurityGroupId: !Ref WebServerSecurityGroup\n\n  ################\n  # IAM Role for EC2 #\n  ################\n\n  EC2Role:\n    Type: 'AWS::IAM::Role'\n    Properties:\n      AssumeRolePolicyDocument:\n        Version: '2012-10-17'\n        Statement:\n          - Effect: Allow\n            Principal:\n              Service: ec2.amazonaws.com\n            Action: 'sts:AssumeRole'\n      ManagedPolicyArns:\n        - 'arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM'\n        - 'arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy'\n      Path: /\n\n  EC2InstanceProfile:\n    Type: 'AWS::IAM::InstanceProfile'\n    Properties:\n      Path: /\n      Roles:\n        - !Ref EC2Role\n\n  ################\n  # Application Load Balancer #\n  ################\n\n  ALB:\n    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'\n    Properties:\n      Scheme: internet-facing\n      SecurityGroups:\n        - !Ref ALBSecurityGroup\n      Subnets:\n        - !Ref PublicSubnet1\n        - !Ref PublicSubnet2\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-ALB'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: 2025-12-01T14:43:59.511373\n\n  ALBListener:\n    Type: 'AWS::ElasticLoadBalancingV2::Listener'\n    Properties:\n      DefaultActions:\n        - Type: forward\n          Target",
  "dependencies": [
    "20-network"
  ],
  "estimated_cost": 0.0,
  "created_at": "2025-12-01T14:44:40.598016"
}