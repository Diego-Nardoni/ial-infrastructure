{
  "phase_number": 99,
  "phase_name": "custom",
  "yaml_content": "```yaml\nAWSTemplateFormatVersion: '2010-09-09'\nDescription: 'Production-ready, secure, highly available, cost-optimized, and observable AWS infrastructure.'\n\nParameters:\n\n  EnvironmentName:\n    Description: An environment name that will be prefixed to resource names\n    Type: String\n    Default: production\n\n  VpcCIDR:\n    Description: Please enter the IP range (CIDR notation) for this VPC\n    Type: String\n    Default: 10.0.0.0/16\n\n  PublicSubnet1CIDR:\n    Description: Please enter the IP range (CIDR notation) for the public subnet in the first Availability Zone\n    Type: String\n    Default: 10.0.0.0/24\n\n  PublicSubnet2CIDR:\n    Description: Please enter the IP range (CIDR notation) for the public subnet in the second Availability Zone\n    Type: String\n    Default: 10.0.1.0/24\n\n  PrivateSubnet1CIDR:\n    Description: Please enter the IP range (CIDR notation) for the private subnet in the first Availability Zone\n    Type: String\n    Default: 10.0.2.0/24\n\n  PrivateSubnet2CIDR:\n    Description: Please enter the IP range (CIDR notation) for the private subnet in the second Availability Zone\n    Type: String\n    Default: 10.0.3.0/24\n\nResources:\n\n  # Security\n  KMSKey:\n    Type: AWS::KMS::Key\n    Properties:\n      Description: KMS key for encryption at rest\n      EnableKeyRotation: True\n      KeyPolicy:\n        Version: '2012-10-17'\n        Id: key-policy\n        Statement:\n          - Sid: Enable IAM User Permissions\n            Effect: Allow\n            Principal:\n              AWS: !Join\n                - ''\n                - - 'arn:aws:iam::'\n                  - !Ref 'AWS::AccountId'\n                  - ':root'\n            Action: 'kms:*'\n            Resource: '*'\n\n  # Network\n  VPC:\n    Type: AWS::EC2::VPC\n    Properties:\n      CidrBlock: !Ref VpcCIDR\n      EnableDnsHostnames: True\n      EnableDnsSupport: True\n      InstanceTenancy: default\n      Tags:\n        - Key: Name\n          Value: !Ref EnvironmentName\n\n  InternetGateway:\n    Type: AWS::EC2::InternetGateway\n    Properties:\n      Tags:\n        - Key: Name\n          Value: !Ref EnvironmentName\n\n  InternetGatewayAttachment:\n    Type: AWS::EC2::VPCGatewayAttachment\n    Properties:\n      InternetGatewayId: !Ref InternetGateway\n      VpcId: !Ref VPC\n\n  PublicSubnet1:\n    Type: AWS::EC2::Subnet\n    Properties:\n      VpcId: !Ref VPC\n      AvailabilityZone: !Select [ 0, !GetAZs '' ]\n      CidrBlock: !Ref PublicSubnet1CIDR\n      MapPublicIpOnLaunch: True\n      Tags:\n        - Key: Name\n          Value: !Sub ${EnvironmentName} Public Subnet (AZ1)\n\n  PublicSubnet2:\n    Type: AWS::EC2::Subnet\n    Properties:\n      VpcId: !Ref VPC\n      AvailabilityZone: !Select [ 1, !GetAZs  '' ]\n      CidrBlock: !Ref PublicSubnet2CIDR\n      MapPublicIpOnLaunch: True\n      Tags:\n        - Key: Name\n          Value: !Sub ${EnvironmentName} Public Subnet (AZ2)\n\n  PrivateSubnet1:\n    Type: AWS::EC2::Subnet\n    Properties:\n      VpcId: !Ref VPC\n      AvailabilityZone: !Select [ 0, !GetAZs '' ]\n      CidrBlock: !Ref PrivateSubnet1CIDR\n      MapPublicIpOnLaunch: False\n      Tags:\n        - Key: Name\n          Value: !Sub ${EnvironmentName} Private Subnet (AZ1)\n\n  PrivateSubnet2:\n    Type: AWS::EC2::Subnet\n    Properties:\n      VpcId: !Ref VPC\n      AvailabilityZone: !Select [ 1, !GetAZs '' ]\n      CidrBlock: !Ref PrivateSubnet2CIDR\n      MapPublicIpOnLaunch: False\n      Tags:\n        - Key: Name\n          Value: !Sub ${EnvironmentName} Private Subnet (AZ2)\n\n  NatGateway1EIP:\n    Type: AWS::EC2::EIP\n    DependsOn: InternetGatewayAttachment\n    Properties:\n      Domain: vpc\n\n  NatGateway2EIP:\n    Type: AWS::EC2::EIP\n    DependsOn: InternetGatewayAttachment\n    Properties:\n      Domain: vpc\n\n  NatGateway1:\n    Type: AWS::EC2::NatGateway\n    Properties:\n      AllocationId: !GetAtt NatGateway1EIP.AllocationId\n      SubnetId: !Ref PublicSubnet1\n\n  NatGateway2:\n    Type: AWS::EC2::NatGateway\n    Properties:\n      AllocationId: !GetAtt NatGateway2EIP.AllocationId\n      SubnetId: !Ref PublicSubnet2\n\n  PublicRouteTable:\n    Type: AWS::EC2::RouteTable\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub ${EnvironmentName} Public Routes\n\n  DefaultPublicRoute:\n    Type: AWS::EC2::Route\n    DependsOn: InternetGatewayAttachment\n    Properties:\n      RouteTableId: !Ref PublicRouteTable\n      DestinationCidrBlock: 0.0.0.0/0\n      GatewayId: !Ref InternetGateway\n\n  PublicSubnet1RouteTableAssociation:\n    Type: AWS::EC2::SubnetRouteTableAssociation\n    Properties:\n      RouteTableId: !Ref PublicRouteTable\n      SubnetId: !Ref PublicSubnet1\n\n  PublicSubnet2RouteTableAssociation:\n    Type: AWS::EC2::SubnetRouteTableAssociation\n    Properties:\n      RouteTableId: !Ref PublicRouteTable\n      SubnetId: !Ref PublicSubnet2\n\n  PrivateRouteTable1:\n    Type: AWS::EC2::RouteTable\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub ${EnvironmentName} Private Routes (AZ1)\n\n  PrivateRouteTable2:\n    Type: AWS::EC2::RouteTable\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub ${EnvironmentName} Private Routes (AZ2)\n\n  PrivateSubnet1RouteTableAssociation:\n    Type: AWS::EC2::SubnetRouteTableAssociation\n    Properties:\n      RouteTableId: !Ref PrivateRouteTable1\n      SubnetId: !Ref PrivateSubnet1\n\n  PrivateSubnet2RouteTableAssociation:\n    Type: AWS::EC2::SubnetRouteTableAssociation\n    Properties:\n      RouteTableId: !Ref PrivateRouteTable2\n      SubnetId: !Ref PrivateSubnet2\n\n  PrivateRoute1:\n    Type: AWS::EC2::Route\n    Properties:\n      RouteTableId: !Ref PrivateRouteTable1\n      DestinationCidrBlock: 0.0.0.0/0\n      NatGatewayId: !Ref NatGateway1\n\n  PrivateRoute2:\n    Type: AWS::EC2::Route\n    Properties:\n      RouteTableId: !Ref PrivateRouteTable2\n      DestinationCidrBlock: 0.0.0.0/0\n      NatGatewayId: !Ref NatGateway2\n\n  # Security Groups\n  LoadBalancerSecurityGroup:\n    Type: AWS::EC2::SecurityGroup\n    Properties:\n      GroupDescription: Allow HTTP from anywhere\n      SecurityGroupIngress:\n        - IpProtocol: tcp\n          FromPort: 80\n          ToPort: 80\n          CidrIp: 0.0.0.0/0\n      VpcId: !Ref VPC\n\n  InstanceSecurityGroup:\n    Type: AWS::EC2::SecurityGroup\n    Properties:\n      GroupDescription: Allow HTTP from load balancer only\n      SecurityGroupIngress:\n        - IpProtocol: tcp\n          FromPort: 8080\n          ToPort: 8080\n          SourceSecurityGroupId: !Ref LoadBalancerSecurityGroup\n      VpcId: !Ref VPC\n\n  # IAM\n  InstanceRole:\n    Type: AWS::IAM::Role\n    Properties:\n      AssumeRolePolicyDocument:\n        Version: '2012-10-17'\n        Statement:\n          - Effect: Allow\n            Principal:\n              Service:\n                - ec2.amazonaws.com\n            Action:\n              - 'sts:AssumeRole'\n      ManagedPolicyArns:\n        - arn:aws:iam::aws:policy/CloudWatchLogsFullAccess\n\n  # Application\n  ApplicationLoadBalancer:\n    Type: AWS::ElasticLoadBalancingV2::LoadBalancer\n    Properties:\n      Scheme: internet-facing\n      SecurityGroups:\n        - !Ref LoadBalancerSecurityGroup\n      Subnets:\n        - !Ref PublicSubnet1\n        - !Ref PublicSubnet2\n\n  TargetGroup:\n    Type: AWS::ElasticLoadBalancingV2::TargetGroup\n    Properties:\n      HealthCheckPath: /\n      Port: 8080\n      Protocol: HTTP\n      TargetType: instance\n      VpcId: !Ref VPC\n\n  Listener:\n    Type: AWS::ElasticLoadBalancingV2::Listener\n    Properties:\n      DefaultActions:\n        - Type: forward\n          TargetGroupArn: !Ref TargetGroup\n      LoadBalancerArn: !Ref ApplicationLoadBalancer\n      Port: 80\n      Protocol: HTTP\n\n  AutoScalingGroup:\n    Type: AWS::AutoScaling::AutoScalingGroup\n    Properties:\n      VPCZoneIdentifier:\n        - !Ref PrivateSubnet1\n        - !Ref PrivateSubnet2\n      LaunchConfigurationName: !Ref LaunchConfiguration\n      MinSize: 2\n      MaxSize: 4\n      TargetGroupARNs:\n        - !Ref TargetGroup\n      HealthCheckGracePeriod: 300\n      HealthCheckType: ELB\n\n  LaunchConfiguration:\n    Type: AWS::AutoScaling::LaunchConfiguration\n    Properties:\n      ImageId: ami-0cff7528ff583bf9a # Amazon Linux 2 AMI (HVM)\n      InstanceType: t3.micro\n      IamInstanceProfile: !Ref InstanceRole\n      KeyName: my-key # Update with your desired key pair\n      SecurityGroups:\n        - !Ref InstanceSecurityGroup\n      UserData:\n        Fn::Base64:\n          !Sub |\n            #!/bin/bash\n            yum update -y\n            yum install -y httpd\n            systemctl start httpd\n            systemctl enable httpd\n\n  # Observability\n  LogGroup:\n    Type: AWS::Logs::LogGroup\n    Properties:\n      RetentionInDays: 7\n\n  CPUHighAlarm:\n    Type: AWS::CloudWatch::Alarm\n    Properties:\n      AlarmDescription: Alarm for high CPU utilization\n      MetricName: CPUUtilization\n      Namespace: AWS/EC2\n      Statistic: Average\n      Period: 300\n      EvaluationPeriods: 2\n      Threshold: 80\n      AlarmActions:\n        - !Ref AlarmTopic\n      Dimensions:\n        - Name: AutoScalingGroupName\n          Value: !Ref AutoScalingGroup\n      ComparisonOperator: GreaterThanThreshold\n\n  AlarmTopic:\n    Type: AWS::SNS::Topic\n    Properties:\n      DisplayName: Operational alerts\n      Subscription:\n        - Protocol: email\n          Endpoint: your.email@example.com # Update with your desired email\n\nOutputs:\n\n  VPC:\n    Description: A reference to the created VPC\n    Value: !Ref VPC\n    Export:\n      Name: !Sub ${EnvironmentName}-VPC\n\n  PublicSubnets:\n    Description: A list of the public subnets\n    Value: !Join [ \",\", [ !Ref PublicSubnet1, !Ref PublicSubnet2 ]]\n    Export:\n      Name: !Sub ${EnvironmentName}-PublicSubnets\n\n  PrivateSubnets:\n    Description: A list of the private subnets\n    Value: !Join [ \",\", [ !Ref PrivateSubnet1, !Ref PrivateSubnet2 ]]\n    Export:\n      Name: !Sub ${EnvironmentName}-PrivateSubnets\n\n  PublicAlbHostname:\n    Description: The public hostname of the application load balancer\n    Value: !GetAtt ApplicationLoadBalancer.DNSName\n    Export:\n      Name: !Sub ${EnvironmentName}-PublicAlbHostname\n\nMetadata:\n  AWS::CloudFormation::Interface:\n    ParameterGroups:\n      - Label:\n          default: Environment\n        Parameters:\n          - EnvironmentName\n      - Label:\n          default: Network Configuration\n        Parameters:\n          - VpcCIDR\n          - PublicSubnet1CIDR\n          - PublicSubnet2CIDR\n          - PrivateSubnet1CIDR\n          - PrivateSubnet2CIDR\n\nTags:\n  - Key: ManagedBy\n    Value: IAL\n  - Key: CreatedAt\n    Value: 2025-12-01T14:27:07.540788\n```",
  "dependencies": [
    "20-network"
  ],
  "estimated_cost": 0.0,
  "created_at": "2025-12-01T14:27:49.931956"
}