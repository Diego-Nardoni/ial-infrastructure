{
  "phase_number": 40,
  "phase_name": "database-alb",
  "yaml_content": "```yaml\nAWSTemplateFormatVersion: '2010-09-09'\nDescription: Web application with load balancer and database\nParameters:\n  EnvironmentName:\n    Description: An environment name that will be prefixed to resource names\n    Type: String\n\n  VPCCIDRRange:\n    Description: A CIDR notation private IPv4 block for the VPC\n    Type: String\n    Default: 10.0.0.0/16\n    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$'\n    ConstraintDescription: Must be a valid CIDR notation IPv4 range\n\nResources:\n\n  # VPC and networking resources\n  VPC:\n    Type: AWS::EC2::VPC\n    Properties:\n      CidrBlock: !Ref VPCCIDRRange\n      EnableDnsHostnames: true\n      EnableDnsSupport: true\n      InstanceTenancy: default\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-VPC'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:11:16.658235'\n\n  InternetGateway:\n    Type: AWS::EC2::InternetGateway\n    Properties:\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-IGW'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:11:16.658235'\n\n  InternetGatewayAttachment:\n    Type: AWS::EC2::VPCGatewayAttachment\n    Properties:\n      InternetGatewayId: !Ref InternetGateway\n      VpcId: !Ref VPC\n\n  PublicSubnet1:\n    Type: AWS::EC2::Subnet\n    Properties:\n      VpcId: !Ref VPC\n      AvailabilityZone: !Select [0, !GetAZs '']\n      CidrBlock: !Select [0, !Cidr [!Ref VPCCIDRRange, 16, 8]]\n      MapPublicIpOnLaunch: true\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-PublicSubnet1'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:11:16.658235'\n\n  PublicSubnet2:\n    Type: AWS::EC2::Subnet\n    Properties:\n      VpcId: !Ref VPC\n      AvailabilityZone: !Select [1, !GetAZs '']\n      CidrBlock: !Select [1, !Cidr [!Ref VPCCIDRRange, 16, 8]]\n      MapPublicIpOnLaunch: true\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-PublicSubnet2'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:11:16.658235'\n\n  PrivateSubnet1:\n    Type: AWS::EC2::Subnet\n    Properties:\n      VpcId: !Ref VPC\n      AvailabilityZone: !Select [0, !GetAZs '']\n      CidrBlock: !Select [2, !Cidr [!Ref VPCCIDRRange, 16, 8]]\n      MapPublicIpOnLaunch: false\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-PrivateSubnet1'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:11:16.658235'\n\n  PrivateSubnet2:\n    Type: AWS::EC2::Subnet\n    Properties:\n      VpcId: !Ref VPC\n      AvailabilityZone: !Select [1, !GetAZs '']\n      CidrBlock: !Select [3, !Cidr [!Ref VPCCIDRRange, 16, 8]]\n      MapPublicIpOnLaunch: false\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-PrivateSubnet2'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:11:16.658235'\n\n  NatGatewayEIP:\n    Type: AWS::EC2::EIP\n    DependsOn: InternetGatewayAttachment\n    Properties:\n      Domain: vpc\n\n  NatGateway:\n    Type: AWS::EC2::NatGateway\n    Properties:\n      AllocationId: !GetAtt NatGatewayEIP.AllocationId\n      SubnetId: !Ref PublicSubnet1\n\n  PublicRouteTable:\n    Type: AWS::EC2::RouteTable\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-PublicRouteTable'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:11:16.658235'\n\n  PrivateRouteTable1:\n    Type: AWS::EC2::RouteTable\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-PrivateRouteTable1'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:11:16.658235'\n\n  PrivateRouteTable2:\n    Type: AWS::EC2::RouteTable\n    Properties:\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-PrivateRouteTable2'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:11:16.658235'\n\n  PublicRoute:\n    Type: AWS::EC2::Route\n    DependsOn: InternetGatewayAttachment\n    Properties:\n      RouteTableId: !Ref PublicRouteTable\n      DestinationCidrBlock: 0.0.0.0/0\n      GatewayId: !Ref InternetGateway\n\n  PrivateRoute1:\n    Type: AWS::EC2::Route\n    Properties:\n      RouteTableId: !Ref PrivateRouteTable1\n      DestinationCidrBlock: 0.0.0.0/0\n      NatGatewayId: !Ref NatGateway\n\n  PrivateRoute2:\n    Type: AWS::EC2::Route\n    Properties:\n      RouteTableId: !Ref PrivateRouteTable2\n      DestinationCidrBlock: 0.0.0.0/0\n      NatGatewayId: !Ref NatGateway\n\n  PublicSubnet1RouteTableAssociation:\n    Type: AWS::EC2::SubnetRouteTableAssociation\n    Properties:\n      SubnetId: !Ref PublicSubnet1\n      RouteTableId: !Ref PublicRouteTable\n\n  PublicSubnet2RouteTableAssociation:\n    Type: AWS::EC2::SubnetRouteTableAssociation\n    Properties:\n      SubnetId: !Ref PublicSubnet2\n      RouteTableId: !Ref PublicRouteTable\n\n  PrivateSubnet1RouteTableAssociation:\n    Type: AWS::EC2::SubnetRouteTableAssociation\n    Properties:\n      SubnetId: !Ref PrivateSubnet1\n      RouteTableId: !Ref PrivateRouteTable1\n\n  PrivateSubnet2RouteTableAssociation:\n    Type: AWS::EC2::SubnetRouteTableAssociation\n    Properties:\n      SubnetId: !Ref PrivateSubnet2\n      RouteTableId: !Ref PrivateRouteTable2\n\n  # Security groups\n  LoadBalancerSecurityGroup:\n    Type: AWS::EC2::SecurityGroup\n    Properties:\n      GroupDescription: Allow HTTP/HTTPS traffic\n      SecurityGroupIngress:\n        - IpProtocol: tcp\n          FromPort: 80\n          ToPort: 80\n          CidrIp: 0.0.0.0/0\n        - IpProtocol: tcp\n          FromPort: 443\n          ToPort: 443\n          CidrIp: 0.0.0.0/0\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-LoadBalancerSecurityGroup'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:11:16.658235'\n\n  WebServerSecurityGroup:\n    Type: AWS::EC2::SecurityGroup\n    Properties:\n      GroupDescription: Allow HTTP/HTTPS from load balancer\n      SecurityGroupIngress:\n        - IpProtocol: tcp\n          FromPort: 80\n          ToPort: 80\n          SourceSecurityGroupId: !Ref LoadBalancerSecurityGroup\n        - IpProtocol: tcp\n          FromPort: 443\n          ToPort: 443\n          SourceSecurityGroupId: !Ref LoadBalancerSecurityGroup\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-WebServerSecurityGroup'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:11:16.658235'\n\n  DatabaseSecurityGroup:\n    Type: AWS::EC2::SecurityGroup\n    Properties:\n      GroupDescription: Allow MySQL traffic from web servers\n      SecurityGroupIngress:\n        - IpProtocol: tcp\n          FromPort: 3306\n          ToPort: 3306\n          SourceSecurityGroupId: !Ref WebServerSecurityGroup\n      VpcId: !Ref VPC\n      Tags:\n        - Key: Name\n          Value: !Sub '${EnvironmentName}-DatabaseSecurityGroup'\n        - Key: ManagedBy\n          Value: IAL\n        - Key: CreatedAt\n          Value: '2025-12-01T14:11:16.658235'\n\n  # IAM role and instance profile\n  WebServerRole:\n    Type: AWS::IAM::Role\n    Properties:\n      AssumeRolePolicyDocument:\n        Version: '2012-10-17'\n        Statement:\n          - Effect: Allow\n            Principal:\n              Service:\n                - ec2.amazonaws.com\n            Action:\n              - 'sts:AssumeRole'\n      ManagedPolicyArns:\n        - 'arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM'\n      Path: /\n\n  WebServerInstanceProfile:\n    Type: AWS::IAM::InstanceProfile\n    Properties:\n      Roles:\n        - !Ref WebServerRole\n\n  # Application Load Balancer\n  LoadBalancer:\n    Type: AWS::ElasticLoadBalancingV2::LoadBalancer\n    Properties:\n      SecurityGroups:\n        - !Ref LoadBalancerSecurityGroup\n      Subnets:\n        - !Ref PublicSubnet1\n        - !Ref PublicSubnet2\n      Type: application\n\n  LoadBalancerListener:\n    Type: AWS::ElasticLoadBalancingV2::Listener\n    Properties:\n      DefaultActions:\n        - Type: forward\n          TargetGroupArn: !Ref TargetGroup\n      LoadBalancerArn: !Ref LoadBalancer\n      Port: 80\n      Protocol: HTTP\n\n  TargetGroup:\n    Type: AWS::ElasticLoadBalancingV2::TargetGroup\n    Properties:\n      HealthCheckPath: /\n      Port: 80\n      Protocol: HTTP\n      TargetType: instance\n      VpcId: !Ref VPC\n\n  # Auto Scaling group and launch configuration\n  WebServerLaunchConfiguration:\n    Type: AWS::AutoScaling::LaunchConfiguration\n    Properties:\n      ImageId: ami-0c94855ba95c71c99 # Replace with your desired AMI\n      InstanceType: t2.micro\n      IamInstanceProfile: !Ref WebServerInstanceProfile\n      SecurityGroups:\n        - !Ref WebServerSecurityGroup\n      UserData:\n        Fn::Base64:\n          !Sub |\n            #!/bin/bash\n            # Install Apache and PHP\n            yum update -y\n            amazon-linux-extras install -y php7.4 lamp-mariadb10.2-php7.4\n            systemctl start httpd\n            systemctl enable httpd\n\n  WebServerAutoScalingGroup:\n    Type: AWS::AutoScaling::AutoScalingGroup\n    Properties:\n      AvailabilityZones: !GetAZs ''\n      DesiredCapacity: '2'\n      HealthCheckGracePeriod: 300\n      HealthCheckType: ELB\n      LaunchConfigurationName: !Ref WebServerLaunchConfiguration\n      MaxSize: '4'\n      MinSize: '2'\n      TargetGroupARNs:\n        - !Ref TargetGroup\n      VPCZoneIdentifier:\n        - !Ref PrivateSubnet1\n        - !Ref PrivateSubnet2\n\n  # RDS MySQL database\n  DatabaseSubnetGroup:\n    Type: AWS::RDS::DBSubnetGroup\n    Properties:\n      DBSubnetGroupDescription: Subnets for the RDS instance\n      SubnetIds:\n        - !Ref PrivateSubnet1\n        - !Ref PrivateSubnet2\n\n  DatabaseInstance:\n    Type: AWS::RDS::DBInstance\n    Properties:\n      AllocatedStorage: 20\n      DBInstanceClass: db.t3.micro\n      DBName: myWebApp\n      Engine: MySQL\n      EngineVersion: 8.0.28\n      MasterUsername: rootuser\n      MasterUserPassword: myRootPassword123\n      MultiAZ: true\n      DBSubnetGroupName: !Ref DatabaseSubnetGroup\n      PubliclyAccessible: false\n      StorageEncrypted: true\n      StorageType: gp2\n      VPCSecurityGroups:\n        - !Ref DatabaseSecurityGroup\n\n  # CloudWatch logs\n  WebServerLogGroup:\n    Type: AWS::Logs::LogGroup\n    Properties:\n      LogGroupName: !Sub '${EnvironmentName}-WebServerLogs'\n      RetentionInDays: 7\n\n# Outputs\nOutputs:\n  VPCId:\n    Description: A reference to the created VPC\n    Value: !Ref VPC\n    Export:\n      Name: !Sub '${EnvironmentName}-VPC'\n\n  PublicSubnets:\n    Description: A list of the public subnets\n    Value: !Join [',', [!Ref PublicSubnet1, !Ref PublicSubnet2]]\n    Export:\n      Name: !Sub '${EnvironmentName}-PublicSubnets'\n\n  PrivateSubnets:\n    Description: A list of the private subnets\n    Value: !Join [',', [!Ref PrivateSubnet1, !Ref PrivateSubnet2]]\n    Export:\n      Name: !Sub '${EnvironmentName}-PrivateSubnets'\n\n  LoadBalancerDNSName:\n    Description: The DNS name of the load balancer\n    Value: !GetAtt LoadBalancer",
  "dependencies": [
    "20-network"
  ],
  "estimated_cost": 0.0,
  "created_at": "2025-12-01T14:11:59.344779"
}