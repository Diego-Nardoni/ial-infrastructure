{
  "metadata": {
    "version": "3.1",
    "deployment_type": "control_plane",
    "generated_at": "2025-11-03T19:27:06.493774",
    "total_phases": 16,
    "builder": "enhanced_desired_state_builder",
    "spec_hash": "5be4700b1be4444e"
  },
  "domains": {
    "00-foundation": {
      "phases": [
        "00-foundation/01-dynamodb-state",
        "00-foundation/02-logging-infrastructure",
        "00-foundation/03-reconciliation-engine",
        "00-foundation/04-backup-strategy",
        "00-foundation/05-chaos-engineering",
        "00-foundation/06-reconciliation-wrapper",
        "00-foundation/07-conversation-memory",
        "00-foundation/08-rag-storage",
        "00-foundation/09-stepfunctions-orchestrator",
        "00-foundation/10-ial-dynamodb-tables",
        "00-foundation/11-ial-s3-storage",
        "00-foundation/12-ial-rag-infrastructure",
        "00-foundation/13-ial-drift-detection",
        "00-foundation/14-ial-lambda-functions",
        "00-foundation/15-ial-bedrock-github-iam",
        "00-foundation/16-ial-test-validation"
      ],
      "resource_count": 35
    }
  },
  "resources": {
    "00-foundation/05-chaos-engineering::FISExecutionRole": {
      "type": "AWS::IAM::Role",
      "properties": {
        "RoleName": "${ProjectName}-fis-execution-role",
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "fis.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AWSFaultInjectionSimulatorNetworkAccess",
          "arn:aws:iam::aws:policy/service-role/AWSFaultInjectionSimulatorECSAccess",
          "arn:aws:iam::aws:policy/service-role/AWSFaultInjectionSimulatorEC2Access"
        ],
        "Policies": [
          {
            "PolicyName": "FISChaosPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "ec2:DescribeInstances",
                    "ec2:StopInstances",
                    "ec2:RebootInstances",
                    "ecs:DescribeServices",
                    "ecs:UpdateService",
                    "ecs:DescribeTasks",
                    "ecs:StopTask",
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents",
                    "cloudwatch:PutMetricData"
                  ],
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      },
      "phase": "00-foundation/05-chaos-engineering",
      "domain": "00-foundation"
    },
    "00-foundation/05-chaos-engineering::NetworkLatencyExperiment": {
      "type": "AWS::FIS::ExperimentTemplate",
      "properties": {
        "Description": "Network latency injection for resilience testing",
        "RoleArn": "FISExecutionRole.Arn",
        "Actions": {
          "NetworkLatency": {
            "ActionId": "aws:network:latency-sources",
            "Parameters": {
              "duration": "PT5M",
              "latencyMs": "100",
              "jitterMs": "50"
            },
            "Targets": {
              "Subnets": "NetworkTargets"
            }
          }
        },
        "Targets": {
          "NetworkTargets": {
            "ResourceType": "aws:ec2:subnet",
            "ResourceTags": {
              "Environment": "Environment"
            },
            "SelectionMode": "PERCENT(50)"
          }
        },
        "StopConditions": [
          {
            "Source": "aws:cloudwatch:alarm",
            "Value": "ChaosStopCondition"
          }
        ],
        "Tags": {
          "Name": "${ProjectName}-network-latency",
          "Environment": "Environment",
          "Type": "chaos-engineering"
        }
      },
      "phase": "00-foundation/05-chaos-engineering",
      "domain": "00-foundation"
    },
    "00-foundation/05-chaos-engineering::InstanceTerminationExperiment": {
      "type": "AWS::FIS::ExperimentTemplate",
      "properties": {
        "Description": "Random instance termination for auto-recovery testing",
        "RoleArn": "FISExecutionRole.Arn",
        "Actions": {
          "StopInstances": {
            "ActionId": "aws:ec2:stop-instances",
            "Parameters": {
              "startInstancesAfterDuration": "PT10M"
            },
            "Targets": {
              "Instances": "InstanceTargets"
            }
          }
        },
        "Targets": {
          "InstanceTargets": {
            "ResourceType": "aws:ec2:instance",
            "ResourceTags": {
              "Environment": "Environment",
              "ChaosEnabled": "true"
            },
            "SelectionMode": "COUNT(1)"
          }
        },
        "StopConditions": [
          {
            "Source": "aws:cloudwatch:alarm",
            "Value": "ChaosStopCondition"
          }
        ],
        "Tags": {
          "Name": "${ProjectName}-instance-termination",
          "Environment": "Environment",
          "Type": "chaos-engineering"
        }
      },
      "phase": "00-foundation/05-chaos-engineering",
      "domain": "00-foundation"
    },
    "00-foundation/05-chaos-engineering::ECSTaskTerminationExperiment": {
      "type": "AWS::FIS::ExperimentTemplate",
      "properties": {
        "Description": "ECS task termination for service resilience testing",
        "RoleArn": "FISExecutionRole.Arn",
        "Actions": {
          "StopTasks": {
            "ActionId": "aws:ecs:stop-task",
            "Parameters": {
              "reason": "Chaos engineering test"
            },
            "Targets": {
              "Tasks": "ECSTaskTargets"
            }
          }
        },
        "Targets": {
          "ECSTaskTargets": {
            "ResourceType": "aws:ecs:task",
            "ResourceTags": {
              "Environment": "Environment"
            },
            "SelectionMode": "PERCENT(25)"
          }
        },
        "StopConditions": [
          {
            "Source": "aws:cloudwatch:alarm",
            "Value": "ChaosStopCondition"
          }
        ],
        "Tags": {
          "Name": "${ProjectName}-ecs-task-termination",
          "Environment": "Environment",
          "Type": "chaos-engineering"
        }
      },
      "phase": "00-foundation/05-chaos-engineering",
      "domain": "00-foundation"
    },
    "00-foundation/05-chaos-engineering::ChaosStopCondition": {
      "type": "AWS::CloudWatch::Alarm",
      "properties": {
        "AlarmName": "${ProjectName}-chaos-stop-condition",
        "AlarmDescription": "Stop chaos experiments if system becomes unhealthy",
        "MetricName": "HealthyHostCount",
        "Namespace": "AWS/ApplicationELB",
        "Statistic": "Average",
        "Period": 60,
        "EvaluationPeriods": 2,
        "Threshold": 1,
        "ComparisonOperator": "LessThanThreshold",
        "TreatMissingData": "breaching"
      },
      "phase": "00-foundation/05-chaos-engineering",
      "domain": "00-foundation"
    },
    "00-foundation/05-chaos-engineering::ChaosNotificationTopic": {
      "type": "AWS::SNS::Topic",
      "properties": {
        "TopicName": "${ProjectName}-chaos-notifications",
        "DisplayName": "IaL Chaos Engineering Notifications"
      },
      "phase": "00-foundation/05-chaos-engineering",
      "domain": "00-foundation"
    },
    "00-foundation/05-chaos-engineering::ChaosLogGroup": {
      "type": "AWS::Logs::LogGroup",
      "properties": {
        "LogGroupName": "/aws/fis/${ProjectName}-chaos",
        "RetentionInDays": 30
      },
      "phase": "00-foundation/05-chaos-engineering",
      "domain": "00-foundation"
    },
    "00-foundation/05-chaos-engineering::ChaosMetricsNamespace": {
      "type": "AWS::CloudWatch::CompositeAlarm",
      "properties": {
        "AlarmName": "${ProjectName}-chaos-health-composite",
        "AlarmDescription": "Composite alarm for chaos engineering health",
        "AlarmRule": "ALARM(\"${ChaosStopCondition}\") OR\nALARM(\"${ProjectName}-high-error-rate\") OR\nALARM(\"${ProjectName}-high-latency\")\n"
      },
      "phase": "00-foundation/05-chaos-engineering",
      "domain": "00-foundation"
    },
    "00-foundation/07-conversation-memory::ConversationHistoryTable": {
      "type": "AWS::DynamoDB::Table",
      "properties": {
        "TableName": "${ProjectName}-conversation-history",
        "BillingMode": "PAY_PER_REQUEST",
        "AttributeDefinitions": [
          {
            "AttributeName": "user_id",
            "AttributeType": "S"
          },
          {
            "AttributeName": "sort_key",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "user_id",
            "KeyType": "HASH"
          },
          {
            "AttributeName": "sort_key",
            "KeyType": "RANGE"
          }
        ],
        "TimeToLiveSpecification": {
          "AttributeName": "ttl",
          "Enabled": true
        },
        "StreamSpecification": {
          "StreamViewType": "NEW_AND_OLD_IMAGES"
        },
        "PointInTimeRecoverySpecification": {
          "PointInTimeRecoveryEnabled": true
        },
        "Tags": [
          {
            "Key": "Project",
            "Value": "ProjectName"
          },
          {
            "Key": "Environment",
            "Value": "Environment"
          },
          {
            "Key": "Purpose",
            "Value": "ConversationHistory"
          },
          {
            "Key": "ManagedBy",
            "Value": "IaL-Framework"
          }
        ]
      },
      "phase": "00-foundation/07-conversation-memory",
      "domain": "00-foundation"
    },
    "00-foundation/07-conversation-memory::UserSessionsTable": {
      "type": "AWS::DynamoDB::Table",
      "properties": {
        "TableName": "${ProjectName}-user-sessions",
        "BillingMode": "PAY_PER_REQUEST",
        "AttributeDefinitions": [
          {
            "AttributeName": "user_id",
            "AttributeType": "S"
          },
          {
            "AttributeName": "session_id",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "user_id",
            "KeyType": "HASH"
          },
          {
            "AttributeName": "session_id",
            "KeyType": "RANGE"
          }
        ],
        "TimeToLiveSpecification": {
          "AttributeName": "ttl",
          "Enabled": true
        },
        "PointInTimeRecoverySpecification": {
          "PointInTimeRecoveryEnabled": true
        },
        "Tags": [
          {
            "Key": "Project",
            "Value": "ProjectName"
          },
          {
            "Key": "Environment",
            "Value": "Environment"
          },
          {
            "Key": "Purpose",
            "Value": "UserSessions"
          },
          {
            "Key": "ManagedBy",
            "Value": "IaL-Framework"
          }
        ]
      },
      "phase": "00-foundation/07-conversation-memory",
      "domain": "00-foundation"
    },
    "00-foundation/07-conversation-memory::ContextWindowsTable": {
      "type": "AWS::DynamoDB::Table",
      "properties": {
        "TableName": "${ProjectName}-context-windows",
        "BillingMode": "PAY_PER_REQUEST",
        "AttributeDefinitions": [
          {
            "AttributeName": "user_id",
            "AttributeType": "S"
          },
          {
            "AttributeName": "window_id",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "user_id",
            "KeyType": "HASH"
          },
          {
            "AttributeName": "window_id",
            "KeyType": "RANGE"
          }
        ],
        "TimeToLiveSpecification": {
          "AttributeName": "ttl",
          "Enabled": true
        },
        "Tags": [
          {
            "Key": "Project",
            "Value": "ProjectName"
          },
          {
            "Key": "Environment",
            "Value": "Environment"
          },
          {
            "Key": "Purpose",
            "Value": "ContextWindows"
          },
          {
            "Key": "ManagedBy",
            "Value": "IaL-Framework"
          }
        ]
      },
      "phase": "00-foundation/07-conversation-memory",
      "domain": "00-foundation"
    },
    "00-foundation/07-conversation-memory::TokenUsageTable": {
      "type": "AWS::DynamoDB::Table",
      "properties": {
        "TableName": "${ProjectName}-token-usage",
        "BillingMode": "PAY_PER_REQUEST",
        "AttributeDefinitions": [
          {
            "AttributeName": "user_id",
            "AttributeType": "S"
          },
          {
            "AttributeName": "date_hour",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "user_id",
            "KeyType": "HASH"
          },
          {
            "AttributeName": "date_hour",
            "KeyType": "RANGE"
          }
        ],
        "TimeToLiveSpecification": {
          "AttributeName": "ttl",
          "Enabled": true
        },
        "Tags": [
          {
            "Key": "Project",
            "Value": "ProjectName"
          },
          {
            "Key": "Environment",
            "Value": "Environment"
          },
          {
            "Key": "Purpose",
            "Value": "TokenUsageTracking"
          },
          {
            "Key": "ManagedBy",
            "Value": "IaL-Framework"
          }
        ]
      },
      "phase": "00-foundation/07-conversation-memory",
      "domain": "00-foundation"
    },
    "00-foundation/07-conversation-memory::ConversationCacheTable": {
      "type": "AWS::DynamoDB::Table",
      "properties": {
        "TableName": "${ProjectName}-conversation-cache",
        "BillingMode": "PAY_PER_REQUEST",
        "AttributeDefinitions": [
          {
            "AttributeName": "cache_key",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "cache_key",
            "KeyType": "HASH"
          }
        ],
        "TimeToLiveSpecification": {
          "AttributeName": "ttl",
          "Enabled": true
        },
        "Tags": [
          {
            "Key": "Project",
            "Value": "ProjectName"
          },
          {
            "Key": "Environment",
            "Value": "Environment"
          },
          {
            "Key": "Purpose",
            "Value": "ConversationCache"
          },
          {
            "Key": "ManagedBy",
            "Value": "IaL-Framework"
          }
        ]
      },
      "phase": "00-foundation/07-conversation-memory",
      "domain": "00-foundation"
    },
    "00-foundation/07-conversation-memory::BedrockConversationRole": {
      "type": "AWS::IAM::Role",
      "properties": {
        "RoleName": "${ProjectName}-bedrock-conversation-role",
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "lambda.amazonaws.com",
                  "ecs-tasks.amazonaws.com"
                ]
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
        ],
        "Policies": [
          {
            "PolicyName": "BedrockConversationPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "bedrock:InvokeModel",
                    "bedrock:InvokeModelWithResponseStream"
                  ],
                  "Resource": [
                    "arn:aws:bedrock:${AWS::Region}::foundation-model/anthropic.claude-3-5-sonnet-20241022-v2:0",
                    "arn:aws:bedrock:${AWS::Region}::foundation-model/anthropic.claude-3-haiku-20240307-v1:0"
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "dynamodb:GetItem",
                    "dynamodb:PutItem",
                    "dynamodb:UpdateItem",
                    "dynamodb:DeleteItem",
                    "dynamodb:Query",
                    "dynamodb:Scan"
                  ],
                  "Resource": [
                    "ConversationHistoryTable.Arn",
                    "UserSessionsTable.Arn",
                    "ContextWindowsTable.Arn",
                    "TokenUsageTable.Arn",
                    "ConversationCacheTable.Arn"
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      },
      "phase": "00-foundation/07-conversation-memory",
      "domain": "00-foundation"
    },
    "00-foundation/07-conversation-memory::ConversationDashboard": {
      "type": "AWS::CloudWatch::Dashboard",
      "properties": {
        "DashboardName": "${ProjectName}-conversation-monitoring",
        "DashboardBody": "{\n  \"widgets\": [\n    {\n      \"type\": \"text\",\n      \"x\": 0,\n      \"y\": 0,\n      \"width\": 24,\n      \"height\": 2,\n      \"properties\": {\n        \"markdown\": \"# ðŸ§  IaL Conversation Monitoring Dashboard\\n**Real-time Bedrock conversation analytics and cost tracking**\"\n      }\n    },\n    {\n      \"type\": \"metric\",\n      \"x\": 0,\n      \"y\": 2,\n      \"width\": 12,\n      \"height\": 6,\n      \"properties\": {\n        \"metrics\": [\n          [\"AWS/DynamoDB\", \"ConsumedReadCapacityUnits\", \"TableName\", \"${ProjectName}-conversation-history\"],\n          [\".\", \"ConsumedWriteCapacityUnits\", \".\", \".\"],\n          [\".\", \"ConsumedReadCapacityUnits\", \"TableName\", \"${ProjectName}-user-sessions\"],\n          [\".\", \"ConsumedWriteCapacityUnits\", \".\", \".\"]\n        ],\n        \"view\": \"timeSeries\",\n        \"stacked\": false,\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"ðŸ“Š DynamoDB Usage\",\n        \"period\": 300,\n        \"stat\": \"Sum\"\n      }\n    },\n    {\n      \"type\": \"metric\",\n      \"x\": 12,\n      \"y\": 2,\n      \"width\": 12,\n      \"height\": 6,\n      \"properties\": {\n        \"metrics\": [\n          [\"IaL/Conversations\", \"TokensUsed\", \"Model\", \"sonnet\"],\n          [\".\", \".\", \".\", \"haiku\"],\n          [\".\", \"ConversationCount\"],\n          [\".\", \"AverageResponseTime\"]\n        ],\n        \"view\": \"timeSeries\",\n        \"stacked\": false,\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"ðŸ¤– Bedrock Usage\",\n        \"period\": 300,\n        \"stat\": \"Sum\"\n      }\n    }\n  ]\n}\n"
      },
      "phase": "00-foundation/07-conversation-memory",
      "domain": "00-foundation"
    },
    "00-foundation/08-rag-storage::RAGStorageBucket": {
      "type": "AWS::S3::Bucket",
      "properties": {
        "BucketName": "ial-rag-store-${Environment}-${AWS::AccountId}",
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "aws:kms",
                "KMSMasterKeyID": "RAGKMSKey"
              },
              "BucketKeyEnabled": true
            }
          ]
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        },
        "VersioningConfiguration": {
          "Status": "Enabled"
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "Id": "DeleteOldVersions",
              "Status": "Enabled",
              "NoncurrentVersionExpirationInDays": 30
            },
            {
              "Id": "DeleteIncompleteMultipartUploads",
              "Status": "Enabled",
              "AbortIncompleteMultipartUpload": {
                "DaysAfterInitiation": 7
              }
            }
          ]
        },
        "NotificationConfiguration": {
          "CloudWatchConfigurations": [
            {
              "Event": "s3:ObjectCreated:*",
              "CloudWatchConfiguration": {
                "LogGroupName": "RAGLogGroup"
              }
            }
          ]
        }
      },
      "phase": "00-foundation/08-rag-storage",
      "domain": "00-foundation"
    },
    "00-foundation/08-rag-storage::RAGKMSKey": {
      "type": "AWS::KMS::Key",
      "properties": {
        "Description": "KMS Key for IaL RAG storage encryption",
        "KeyPolicy": {
          "Statement": [
            {
              "Sid": "Enable IAM User Permissions",
              "Effect": "Allow",
              "Principal": {
                "AWS": "arn:aws:iam::${AWS::AccountId}:root"
              },
              "Action": "kms:*",
              "Resource": "*"
            },
            {
              "Sid": "Allow RAG service access",
              "Effect": "Allow",
              "Principal": {
                "AWS": "RAGServiceRole.Arn"
              },
              "Action": [
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:GenerateDataKey",
                "kms:ReEncrypt*"
              ],
              "Resource": "*"
            }
          ]
        }
      },
      "phase": "00-foundation/08-rag-storage",
      "domain": "00-foundation"
    },
    "00-foundation/08-rag-storage::RAGKMSKeyAlias": {
      "type": "AWS::KMS::Alias",
      "properties": {
        "AliasName": "alias/ial-rag-encryption",
        "TargetKeyId": "RAGKMSKey"
      },
      "phase": "00-foundation/08-rag-storage",
      "domain": "00-foundation"
    },
    "00-foundation/08-rag-storage::RAGServiceRole": {
      "type": "AWS::IAM::Role",
      "properties": {
        "RoleName": "IaL-RAG-ServiceRole-${Environment}",
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "lambda.amazonaws.com",
                  "ecs-tasks.amazonaws.com"
                ]
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
        ],
        "Policies": [
          {
            "PolicyName": "RAGStorageAccess",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:GetObject",
                    "s3:PutObject",
                    "s3:DeleteObject",
                    "s3:ListBucket"
                  ],
                  "Resource": [
                    "RAGStorageBucket.Arn",
                    "${RAGStorageBucket.Arn}/*"
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "bedrock:InvokeModel",
                    "bedrock:ListFoundationModels"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "kms:Decrypt",
                    "kms:DescribeKey",
                    "kms:Encrypt",
                    "kms:GenerateDataKey"
                  ],
                  "Resource": "RAGKMSKey.Arn"
                }
              ]
            }
          }
        ]
      },
      "phase": "00-foundation/08-rag-storage",
      "domain": "00-foundation"
    },
    "00-foundation/08-rag-storage::RAGLogGroup": {
      "type": "AWS::Logs::LogGroup",
      "properties": {
        "LogGroupName": "/aws/ial/rag/${Environment}",
        "RetentionInDays": 30
      },
      "phase": "00-foundation/08-rag-storage",
      "domain": "00-foundation"
    },
    "00-foundation/09-stepfunctions-orchestrator::StepFunctionsExecutionRole": {
      "type": "AWS::IAM::Role",
      "properties": {
        "RoleName": "${ProjectName}-stepfunctions-execution-role",
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "states.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AWSXRayDaemonWriteAccess"
        ],
        "Policies": [
          {
            "PolicyName": "StepFunctionsLambdaInvoke",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "lambda:InvokeFunction"
                  ],
                  "Resource": "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:ial-*"
                }
              ]
            }
          },
          {
            "PolicyName": "StepFunctionsLogging",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/stepfunctions/ial-*"
                }
              ]
            }
          },
          {
            "PolicyName": "CloudWatchMetrics",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "cloudwatch:PutMetricData"
                  ],
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      },
      "phase": "00-foundation/09-stepfunctions-orchestrator",
      "domain": "00-foundation"
    },
    "00-foundation/09-stepfunctions-orchestrator::LambdaExecutionRole": {
      "type": "AWS::IAM::Role",
      "properties": {
        "RoleName": "${ProjectName}-lambda-execution-role",
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
          "arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess"
        ],
        "Policies": [
          {
            "PolicyName": "IALOperations",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "cloudformation:CreateChangeSet",
                    "cloudformation:ExecuteChangeSet",
                    "cloudformation:DescribeChangeSet",
                    "cloudformation:DescribeStacks",
                    "cloudformation:DescribeStackEvents",
                    "cloudformation:DescribeStackResources",
                    "cloudformation:GetTemplate",
                    "cloudformation:ListStackResources"
                  ],
                  "Resource": "arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/ial-*/*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "dynamodb:GetItem",
                    "dynamodb:PutItem",
                    "dynamodb:UpdateItem",
                    "dynamodb:Query",
                    "dynamodb:Scan"
                  ],
                  "Resource": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/ial-*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ssm:GetParameter",
                    "ssm:GetParameters",
                    "ssm:PutParameter"
                  ],
                  "Resource": "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/ial/*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:GetObject",
                    "s3:PutObject",
                    "s3:ListBucket"
                  ],
                  "Resource": [
                    "arn:aws:s3:::ial-*",
                    "arn:aws:s3:::ial-*/*"
                  ]
                }
              ]
            }
          }
        ]
      },
      "phase": "00-foundation/09-stepfunctions-orchestrator",
      "domain": "00-foundation"
    },
    "00-foundation/09-stepfunctions-orchestrator::PhasePipelineStateMachine": {
      "type": "AWS::StepFunctions::StateMachine",
      "properties": {
        "StateMachineName": "${ProjectName}-phase-pipeline",
        "StateMachineType": "STANDARD",
        "RoleArn": "StepFunctionsExecutionRole.Arn",
        "LoggingConfiguration": {
          "Level": "ALL",
          "IncludeExecutionData": true,
          "Destinations": [
            {
              "CloudWatchLogsLogGroup": {
                "LogGroupArn": "PhasePipelineLogGroup.Arn"
              }
            }
          ]
        },
        "TracingConfiguration": {
          "Enabled": true
        },
        "DefinitionString": "{\n  \"Comment\": \"IAL Phase Pipeline with Circuit Breaker and SAGA Pattern\",\n  \"StartAt\": \"CircuitBreakerCheck\",\n  \"States\": {\n    \"CircuitBreakerCheck\": {\n      \"Type\": \"Task\",\n      \"Resource\": \"arn:aws:states:::lambda:invoke\",\n      \"Parameters\": {\n        \"FunctionName\": \"ial-circuit-guard-lambda\",\n        \"Payload.$\": \"$\"\n      },\n      \"ResultPath\": \"$.circuit\",\n      \"Next\": \"CircuitChoice\",\n      \"Retry\": [{\"ErrorEquals\": [\"States.ALL\"], \"IntervalSeconds\": 2, \"BackoffRate\": 2.0, \"MaxAttempts\": 3}]\n    },\n    \"CircuitChoice\": {\n      \"Type\": \"Choice\",\n      \"Choices\": [{\"Variable\": \"$.circuit.Payload.circuit\", \"StringEquals\": \"OPEN\", \"Next\": \"CircuitOpen\"}],\n      \"Default\": \"PlanPhase\"\n    },\n    \"CircuitOpen\": {\n      \"Type\": \"Fail\",\n      \"Cause\": \"Circuit breaker is open\",\n      \"Error\": \"CircuitBreakerOpen\"\n    },\n    \"PlanPhase\": {\n      \"Type\": \"Task\",\n      \"Resource\": \"arn:aws:states:::lambda:invoke\",\n      \"Parameters\": {\"FunctionName\": \"ial-plan-lambda\", \"Payload.$\": \"$\"},\n      \"ResultPath\": \"$.plan\",\n      \"Next\": \"ApplyChangeSet\",\n      \"Retry\": [{\"ErrorEquals\": [\"States.ALL\"], \"IntervalSeconds\": 5, \"BackoffRate\": 2.0, \"MaxAttempts\": 3}],\n      \"Catch\": [{\"ErrorEquals\": [\"States.ALL\"], \"Next\": \"RollbackSaga\"}]\n    },\n    \"ApplyChangeSet\": {\n      \"Type\": \"Task\",\n      \"Resource\": \"arn:aws:states:::lambda:invoke\",\n      \"Parameters\": {\"FunctionName\": \"ial-apply-lambda\", \"Payload.$\": \"$\"},\n      \"ResultPath\": \"$.apply\",\n      \"Next\": \"AuditValidator\",\n      \"Retry\": [{\"ErrorEquals\": [\"States.ALL\"], \"IntervalSeconds\": 10, \"BackoffRate\": 2.0, \"MaxAttempts\": 3}],\n      \"Catch\": [{\"ErrorEquals\": [\"States.ALL\"], \"Next\": \"RollbackSaga\"}]\n    },\n    \"AuditValidator\": {\n      \"Type\": \"Task\",\n      \"Resource\": \"arn:aws:states:::lambda:invoke\",\n      \"Parameters\": {\"FunctionName\": \"ial-audit-validator-lambda\", \"Payload.$\": \"$\"},\n      \"ResultPath\": \"$.audit\",\n      \"Next\": \"PublishMetrics\",\n      \"Catch\": [{\"ErrorEquals\": [\"States.ALL\"], \"Next\": \"RollbackSaga\"}]\n    },\n    \"PublishMetrics\": {\n      \"Type\": \"Task\",\n      \"Resource\": \"arn:aws:states:::aws-sdk:cloudwatch:putMetricData\",\n      \"Parameters\": {\n        \"Namespace\": \"IAL/Pipeline\",\n        \"MetricData\": [{\"MetricName\": \"PipelineSuccess\", \"Value\": 1, \"Unit\": \"Count\"}]\n      },\n      \"End\": true\n    },\n    \"RollbackSaga\": {\n      \"Type\": \"Task\",\n      \"Resource\": \"arn:aws:states:::lambda:invoke\",\n      \"Parameters\": {\"FunctionName\": \"ial-rollback-lambda\", \"Payload.$\": \"$\"},\n      \"End\": true\n    }\n  }\n}\n"
      },
      "phase": "00-foundation/09-stepfunctions-orchestrator",
      "domain": "00-foundation"
    },
    "00-foundation/09-stepfunctions-orchestrator::DriftAutoHealStateMachine": {
      "type": "AWS::StepFunctions::StateMachine",
      "properties": {
        "StateMachineName": "${ProjectName}-drift-autoheal",
        "StateMachineType": "EXPRESS",
        "RoleArn": "StepFunctionsExecutionRole.Arn",
        "LoggingConfiguration": {
          "Level": "ERROR",
          "IncludeExecutionData": false,
          "Destinations": [
            {
              "CloudWatchLogsLogGroup": {
                "LogGroupArn": "DriftAutoHealLogGroup.Arn"
              }
            }
          ]
        },
        "DefinitionString": "{\n  \"Comment\": \"IAL Drift Auto-Heal Express Workflow\",\n  \"StartAt\": \"DetectDrift\",\n  \"States\": {\n    \"DetectDrift\": {\n      \"Type\": \"Task\",\n      \"Resource\": \"arn:aws:states:::lambda:invoke\",\n      \"Parameters\": {\"FunctionName\": \"ial-drift-detect-lambda\", \"Payload.$\": \"$\"},\n      \"ResultPath\": \"$.drift\",\n      \"Next\": \"DriftChoice\"\n    },\n    \"DriftChoice\": {\n      \"Type\": \"Choice\",\n      \"Choices\": [\n        {\"Variable\": \"$.drift.Payload.safe\", \"BooleanEquals\": true, \"Next\": \"AutoReconcile\"},\n        {\"Variable\": \"$.drift.Payload.detected\", \"BooleanEquals\": false, \"Next\": \"NoDrift\"}\n      ],\n      \"Default\": \"GeneratePR\"\n    },\n    \"NoDrift\": {\n      \"Type\": \"Pass\",\n      \"Result\": \"No drift detected\",\n      \"End\": true\n    },\n    \"AutoReconcile\": {\n      \"Type\": \"Task\",\n      \"Resource\": \"arn:aws:states:::lambda:invoke\",\n      \"Parameters\": {\"FunctionName\": \"ial-drift-reconcile-lambda\", \"Payload.$\": \"$\"},\n      \"Next\": \"PublishReconcileMetrics\"\n    },\n    \"GeneratePR\": {\n      \"Type\": \"Task\",\n      \"Resource\": \"arn:aws:states:::lambda:invoke\",\n      \"Parameters\": {\"FunctionName\": \"ial-reverse-sync-lambda\", \"Payload.$\": \"$\"},\n      \"Next\": \"PublishPRMetrics\"\n    },\n    \"PublishReconcileMetrics\": {\n      \"Type\": \"Task\",\n      \"Resource\": \"arn:aws:states:::aws-sdk:cloudwatch:putMetricData\",\n      \"Parameters\": {\n        \"Namespace\": \"IAL/Drift\",\n        \"MetricData\": [{\"MetricName\": \"Reconciled\", \"Value\": 1, \"Unit\": \"Count\"}]\n      },\n      \"End\": true\n    },\n    \"PublishPRMetrics\": {\n      \"Type\": \"Task\",\n      \"Resource\": \"arn:aws:states:::aws-sdk:cloudwatch:putMetricData\",\n      \"Parameters\": {\n        \"Namespace\": \"IAL/Drift\", \n        \"MetricData\": [{\"MetricName\": \"PRGenerated\", \"Value\": 1, \"Unit\": \"Count\"}]\n      },\n      \"End\": true\n    }\n  }\n}\n"
      },
      "phase": "00-foundation/09-stepfunctions-orchestrator",
      "domain": "00-foundation"
    },
    "00-foundation/09-stepfunctions-orchestrator::PhasePipelineLogGroup": {
      "type": "AWS::Logs::LogGroup",
      "properties": {
        "LogGroupName": "/aws/stepfunctions/${ProjectName}-phase-pipeline",
        "RetentionInDays": 14
      },
      "phase": "00-foundation/09-stepfunctions-orchestrator",
      "domain": "00-foundation"
    },
    "00-foundation/09-stepfunctions-orchestrator::DriftAutoHealLogGroup": {
      "type": "AWS::Logs::LogGroup",
      "properties": {
        "LogGroupName": "/aws/stepfunctions/${ProjectName}-drift-autoheal",
        "RetentionInDays": 7
      },
      "phase": "00-foundation/09-stepfunctions-orchestrator",
      "domain": "00-foundation"
    },
    "00-foundation/09-stepfunctions-orchestrator::DriftScannerRule": {
      "type": "AWS::Events::Rule",
      "properties": {
        "Name": "${ProjectName}-drift-scanner",
        "Description": "Trigger drift detection every 15 minutes",
        "ScheduleExpression": "rate(15 minutes)",
        "State": "ENABLED",
        "Targets": [
          {
            "Arn": "DriftAutoHealStateMachine",
            "Id": "DriftAutoHealTarget",
            "RoleArn": "EventBridgeRole.Arn",
            "Input": "{\n  \"scope\": \"global\",\n  \"region\": \"us-east-1\",\n  \"source\": \"eventbridge-scheduler\"\n}\n"
          }
        ]
      },
      "phase": "00-foundation/09-stepfunctions-orchestrator",
      "domain": "00-foundation"
    },
    "00-foundation/09-stepfunctions-orchestrator::EventBridgeRole": {
      "type": "AWS::IAM::Role",
      "properties": {
        "RoleName": "${ProjectName}-eventbridge-stepfunctions-role",
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "events.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "StepFunctionsExecution",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "states:StartExecution",
                  "Resource": "DriftAutoHealStateMachine"
                }
              ]
            }
          }
        ]
      },
      "phase": "00-foundation/09-stepfunctions-orchestrator",
      "domain": "00-foundation"
    },
    "00-foundation/09-stepfunctions-orchestrator::CircuitBreakerState": {
      "type": "AWS::SSM::Parameter",
      "properties": {
        "Name": "/ial/circuit_breaker/state",
        "Type": "String",
        "Value": "closed",
        "Description": "Circuit breaker state (closed/half_open/open)"
      },
      "phase": "00-foundation/09-stepfunctions-orchestrator",
      "domain": "00-foundation"
    },
    "00-foundation/09-stepfunctions-orchestrator::CircuitBreakerMaxInflight": {
      "type": "AWS::SSM::Parameter",
      "properties": {
        "Name": "/ial/circuit_breaker/max_inflight",
        "Type": "String",
        "Value": "3",
        "Description": "Maximum concurrent executions"
      },
      "phase": "00-foundation/09-stepfunctions-orchestrator",
      "domain": "00-foundation"
    },
    "00-foundation/09-stepfunctions-orchestrator::CircuitBreakerRetryAfter": {
      "type": "AWS::SSM::Parameter",
      "properties": {
        "Name": "/ial/circuit_breaker/retry_after_sec",
        "Type": "String",
        "Value": "120",
        "Description": "Retry after seconds when circuit is open"
      },
      "phase": "00-foundation/09-stepfunctions-orchestrator",
      "domain": "00-foundation"
    },
    "00-foundation/10-ial-dynamodb-tables::UniversalTesttable": {
      "type": "AWS::DynamoDB::Table",
      "properties": {},
      "phase": "00-foundation/10-ial-dynamodb-tables",
      "domain": "00-foundation"
    },
    "00-foundation/10-ial-dynamodb-tables::UniversalMcpprovisioningchecklist": {
      "type": "AWS::DynamoDB::Table",
      "properties": {
        "TableName": "mcp-provisioning-checklist"
      },
      "phase": "00-foundation/10-ial-dynamodb-tables",
      "domain": "00-foundation"
    },
    "00-foundation/11-ial-s3-storage::AdHocTestautodiscoverybucket1761257199": {
      "type": "AWS::S3::Bucket",
      "properties": {
        "BucketName": "test-auto-discovery-bucket-1761257199"
      },
      "phase": "00-foundation/11-ial-s3-storage",
      "domain": "00-foundation"
    },
    "00-foundation/14-ial-lambda-functions::UniversalDriftdetector": {
      "type": "AWS::Lambda::Function",
      "properties": {
        "FunctionName": "drift-detector",
        "Runtime": "python3.11"
      },
      "phase": "00-foundation/14-ial-lambda-functions",
      "domain": "00-foundation"
    }
  },
  "dependencies": {},
  "tags": {
    "ial:deployment-type": "control_plane",
    "ial:generated-by": "enhanced-desired-state-builder",
    "ial:version": "3.1"
  }
}