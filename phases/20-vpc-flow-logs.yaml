# PHASE 13: VPC FLOW LOGS (5 recursos)
# Dependências: VPC, Subnets, IAM Role, KMS (Phases 01, 03, 05)
# Custo: $30/mês

project:
  name: "{{PROJECT_NAME}}"
  phase: "13-vpc-flow-logs"
  executor: "{{EXECUTOR_NAME}}"
  resources: 5

# RECURSO 1: VPC-level Log Group
vpc_log_group:
  workflow:
    step_1_register_pending:
      action: "update_dynamodb"
      table: "mcp-provisioning-checklist"
      item:
        Project: "{{PROJECT_NAME}}"
        ResourceName: "/aws/vpc/flowlogs/{{PROJECT_NAME}}-vpc"
        Status: "Pending"
        Phase: "13-vpc-flow-logs"
        Executor: "{{EXECUTOR_NAME}}"
        Timestamp: "{{current_timestamp}}"
    
    step_2_generate:
      action: "generate_infrastructure_code"
      resource_type: "AWS::Logs::LogGroup"
      properties:
        LogGroupName: "/aws/vpc/flowlogs/{{PROJECT_NAME}}-vpc"
        RetentionInDays: 90
        KmsKeyId: "arn:aws:kms:{{AWS_REGION}}:{{AWS_ACCOUNT_ID}}:key/{{kms_key_id}}"
        Tags:
          - Key: "Project"
            Value: "{{PROJECT_NAME}}"
          - Key: "ManagedBy"
            Value: "MCP"
    
    step_3_explain:
      action: "explain"
    
    step_4_create:
      action: "create_resource"
    
    step_5_update_created:
      action: "update_dynamodb"
      status: "Created"
      arn: "{{log_group_arn}}"
    
    step_6_verify:
      action: "aws_cli"
      command: "aws logs describe-log-groups --log-group-name-prefix /aws/vpc/flowlogs/{{PROJECT_NAME}}-vpc --region {{AWS_REGION}}"
      validation:
        - "logGroups[0].retentionInDays == 90"
    
    step_7_update_verified:
      action: "update_dynamodb"
      status: "Verified"
    
    step_8_on_error:
      action: "update_dynamodb"
      status: "Failed"

# RECURSO 2: Private Subnets Log Group
private_log_group:
  workflow:
    step_1_register_pending:
      action: "update_dynamodb"
      table: "mcp-provisioning-checklist"
      item:
        Project: "{{PROJECT_NAME}}"
        ResourceName: "/aws/vpc/flowlogs/private-subnets"
        Status: "Pending"
        Phase: "13-vpc-flow-logs"
        Executor: "{{EXECUTOR_NAME}}"
        Timestamp: "{{current_timestamp}}"
    
    step_2_generate:
      action: "generate_infrastructure_code"
      resource_type: "AWS::Logs::LogGroup"
      properties:
        LogGroupName: "/aws/vpc/flowlogs/private-subnets"
        RetentionInDays: 30
        KmsKeyId: "arn:aws:kms:{{AWS_REGION}}:{{AWS_ACCOUNT_ID}}:key/{{kms_key_id}}"
        Tags:
          - Key: "Project"
            Value: "{{PROJECT_NAME}}"
          - Key: "ManagedBy"
            Value: "MCP"
    
    step_3_explain:
      action: "explain"
    
    step_4_create:
      action: "create_resource"
    
    step_5_update_created:
      action: "update_dynamodb"
      status: "Created"
    
    step_6_verify:
      action: "aws_cli"
      command: "aws logs describe-log-groups --log-group-name-prefix /aws/vpc/flowlogs/private-subnets --region {{AWS_REGION}}"
      validation:
        - "logGroups[0].retentionInDays == 30"
    
    step_7_update_verified:
      action: "update_dynamodb"
      status: "Verified"
    
    step_8_on_error:
      action: "update_dynamodb"
      status: "Failed"

# RECURSO 3: Public Subnets Log Group
public_log_group:
  workflow:
    step_1_register_pending:
      action: "update_dynamodb"
      table: "mcp-provisioning-checklist"
      item:
        Project: "{{PROJECT_NAME}}"
        ResourceName: "/aws/vpc/flowlogs/public-subnets"
        Status: "Pending"
        Phase: "13-vpc-flow-logs"
        Executor: "{{EXECUTOR_NAME}}"
        Timestamp: "{{current_timestamp}}"
    
    step_2_generate:
      action: "generate_infrastructure_code"
      resource_type: "AWS::Logs::LogGroup"
      properties:
        LogGroupName: "/aws/vpc/flowlogs/public-subnets"
        RetentionInDays: 30
        KmsKeyId: "arn:aws:kms:{{AWS_REGION}}:{{AWS_ACCOUNT_ID}}:key/{{kms_key_id}}"
        Tags:
          - Key: "Project"
            Value: "{{PROJECT_NAME}}"
          - Key: "ManagedBy"
            Value: "MCP"
    
    step_3_explain:
      action: "explain"
    
    step_4_create:
      action: "create_resource"
    
    step_5_update_created:
      action: "update_dynamodb"
      status: "Created"
    
    step_6_verify:
      action: "aws_cli"
      command: "aws logs describe-log-groups --log-group-name-prefix /aws/vpc/flowlogs/public-subnets --region {{AWS_REGION}}"
      validation:
        - "logGroups[0].retentionInDays == 30"
    
    step_7_update_verified:
      action: "update_dynamodb"
      status: "Verified"
    
    step_8_on_error:
      action: "update_dynamodb"
      status: "Failed"

# RECURSO 4: VPC-level Flow Logs (ALL traffic)
vpc_flow_logs:
  workflow:
    step_1_register_pending:
      action: "update_dynamodb"
      table: "mcp-provisioning-checklist"
      item:
        Project: "{{PROJECT_NAME}}"
        ResourceName: "vpc-flowlogs-all"
        Status: "Pending"
        Phase: "13-vpc-flow-logs"
        Executor: "{{EXECUTOR_NAME}}"
        Timestamp: "{{current_timestamp}}"
    
    step_2_generate:
      action: "generate_infrastructure_code"
      resource_type: "AWS::EC2::FlowLog"
      properties:
        ResourceType: "VPC"
        ResourceIds:
          - "{{vpc_id}}"
        TrafficType: "ALL"
        LogDestinationType: "cloud-watch-logs"
        LogGroupName: "/aws/vpc/flowlogs/{{PROJECT_NAME}}-vpc"
        DeliverLogsPermissionArn: "arn:aws:iam::{{AWS_ACCOUNT_ID}}:role/{{PROJECT_NAME}}-flowlogs-role"
        Tags:
          - Key: "Project"
            Value: "{{PROJECT_NAME}}"
          - Key: "ManagedBy"
            Value: "MCP"
    
    step_3_explain:
      action: "explain"
    
    step_4_create:
      action: "create_resource"
    
    step_5_update_created:
      action: "update_dynamodb"
      status: "Created"
      id: "{{flow_log_id}}"
    
    step_6_verify:
      action: "aws_cli"
      command: "aws ec2 describe-flow-logs --filter Name=resource-id,Values={{vpc_id}} --region {{AWS_REGION}}"
      validation:
        - "FlowLogs[0].TrafficType == 'ALL'"
    
    step_7_update_verified:
      action: "update_dynamodb"
      status: "Verified"
    
    step_8_on_error:
      action: "update_dynamodb"
      status: "Failed"

# RECURSO 5: Private Subnets Flow Logs (REJECT only)
private_flow_logs:
  workflow:
    step_1_register_pending:
      action: "update_dynamodb"
      table: "mcp-provisioning-checklist"
      item:
        Project: "{{PROJECT_NAME}}"
        ResourceName: "private-subnets-flowlogs-reject"
        Status: "Pending"
        Phase: "13-vpc-flow-logs"
        Executor: "{{EXECUTOR_NAME}}"
        Timestamp: "{{current_timestamp}}"
    
    step_2_generate:
      action: "generate_infrastructure_code"
      resource_type: "AWS::EC2::FlowLog"
      properties:
        ResourceType: "Subnet"
        ResourceIds:
          - "{{private_subnet_1a_id}}"
          - "{{private_subnet_1b_id}}"
          - "{{private_subnet_1c_id}}"
        TrafficType: "REJECT"
        LogDestinationType: "cloud-watch-logs"
        LogGroupName: "/aws/vpc/flowlogs/private-subnets"
        DeliverLogsPermissionArn: "arn:aws:iam::{{AWS_ACCOUNT_ID}}:role/{{PROJECT_NAME}}-flowlogs-role"
        Tags:
          - Key: "Project"
            Value: "{{PROJECT_NAME}}"
          - Key: "ManagedBy"
            Value: "MCP"
    
    step_3_explain:
      action: "explain"
    
    step_4_create:
      action: "create_resource"
    
    step_5_update_created:
      action: "update_dynamodb"
      status: "Created"
    
    step_6_verify:
      action: "aws_cli"
      command: "aws ec2 describe-flow-logs --filter Name=resource-id,Values={{private_subnet_1a_id}} --region {{AWS_REGION}}"
      validation:
        - "FlowLogs[0].TrafficType == 'REJECT'"
    
    step_7_update_verified:
      action: "update_dynamodb"
      status: "Verified"
    
    step_8_on_error:
      action: "update_dynamodb"
      status: "Failed"
