# PHASE 06: ECR REPOSITORY (1 recurso)
# Dependências: KMS key (Phase 01)
# Custo: $0/mês (storage-based)

project:
  name: "{{PROJECT_NAME}}"
  phase: "06-ecr"
  executor: "{{EXECUTOR_NAME}}"
  resources: 1

# RECURSO 1: ECR Repository
ecr_repository:
  workflow:
    step_1_register_pending:
      action: "update_dynamodb"
      table: "mcp-provisioning-checklist"
      item:
        Project: "{{PROJECT_NAME}}"
        ResourceName: "{{PROJECT_NAME}}-ecr"
        Status: "Pending"
        Phase: "06-ecr"
        Executor: "{{EXECUTOR_NAME}}"
        Timestamp: "{{current_timestamp}}"
    
    step_2_generate:
      action: "generate_infrastructure_code"
      resource_type: "AWS::ECR::Repository"
      properties:
        RepositoryName: "{{PROJECT_NAME}}"
        ImageScanningConfiguration:
          ScanOnPush: true
        EncryptionConfiguration:
          EncryptionType: "KMS"
          KmsKey: "alias/poc-encryption-key"
        ImageTagMutability: "MUTABLE"
        LifecyclePolicy:
          LifecyclePolicyText: |
            {
              "rules": [
                {
                  "rulePriority": 1,
                  "description": "Keep last 10 images",
                  "selection": {
                    "tagStatus": "any",
                    "countType": "imageCountMoreThan",
                    "countNumber": 10
                  },
                  "action": {
                    "type": "expire"
                  }
                }
              ]
            }
        Tags:
          - Key: "Project"
            Value: "{{PROJECT_NAME}}"
          - Key: "ManagedBy"
            Value: "MCP"
    
    step_3_explain:
      action: "explain"
      note: "MANDATORY - User must confirm before proceeding"
    
    step_4_create:
      action: "create_resource"
      note: "Execute only after user confirmation"
    
    step_5_update_created:
      action: "update_dynamodb"
      status: "Created"
      arn: "{{repository_arn}}"
    
    step_6_verify:
      action: "aws_cli"
      command: "aws ecr describe-repositories --repository-names {{PROJECT_NAME}} --region {{AWS_REGION}}"
      validation:
        - "repositories[0].repositoryName == '{{PROJECT_NAME}}'"
        - "repositories[0].imageScanningConfiguration.scanOnPush == true"
        - "repositories[0].encryptionConfiguration.encryptionType == 'KMS'"
    
    step_7_update_verified:
      action: "update_dynamodb"
      status: "Verified"
    
    step_8_on_error:
      action: "update_dynamodb"
      status: "Failed"
      error_message: "{{error_details}}"

  critical_validation:
    note: "ECR repository MUST exist with scanOnPush=true BEFORE ECS Task Definition"
    command: "aws ecr describe-repositories --repository-names {{PROJECT_NAME}} --region {{AWS_REGION}} --query 'repositories[0].imageScanningConfiguration.scanOnPush'"
    expected: "true"
