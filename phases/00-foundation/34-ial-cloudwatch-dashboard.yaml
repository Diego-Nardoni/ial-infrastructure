AWSTemplateFormatVersion: '2010-09-09'
Description: 'IAL Foundation - CloudWatch Dashboard'

Parameters:
  ProjectName:
    Type: String
    Default: ial
    Description: Project name for resource naming

Resources:
  IALSystemDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: ial-system-dashboard
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "x": 0,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/States", "ExecutionsSucceeded", "StateMachineArn", "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:ial-phase-pipeline"],
                  [".", "ExecutionsFailed", ".", "."],
                  [".", "ExecutionsSucceeded", ".", "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:ial-drift-autoheal"],
                  [".", "ExecutionsFailed", ".", "."]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Step Functions Executions"
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Duration", "FunctionName", "ial-plan-lambda"],
                  [".", "Errors", ".", "."],
                  [".", "Duration", ".", "ial-apply-lambda"],
                  [".", "Errors", ".", "."]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "Lambda Performance"
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 6,
              "width": 24,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/DynamoDB", "ConsumedReadCapacityUnits", "TableName", "ial-conversation-history"],
                  [".", "ConsumedWriteCapacityUnits", ".", "."],
                  [".", "ConsumedReadCapacityUnits", ".", "ial-resource-catalog"],
                  [".", "ConsumedWriteCapacityUnits", ".", "."]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "DynamoDB Usage"
              }
            }
          ]
        }

Outputs:
  DashboardURL:
    Description: CloudWatch Dashboard URL
    Value: !Sub 'https://${AWS::Region}.console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${IALSystemDashboard}'
    Export:
      Name: !Sub '${ProjectName}-DashboardURL'
